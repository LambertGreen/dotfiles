#+TITLE: Dotfiles
#+AUTHOR: Lambert Green
#+DESCRIPTION: Cross-platform system configuration management and package management system
#+STARTUP: overview


* Introduction

This is a comprehensive cross-platform dotfiles and unified package management system - think of it as a better, more flexible Topgrade. It provides a single interface to manage packages across multiple package managers, while also handling dotfiles deployment and system configuration.

** Key Features

- **Unified Package Management** - Single command updates packages across all your package managers:
  - System: brew/cask, pacman/AUR, apt, mas (Mac App Store)
  - Languages: npm, pip, gem, cargo (coming soon)
  - Applications: zinit (zsh), elpaca (emacs), lazy.nvim (planned)
- **Smart Configuration** - Tiered setup options from minimal CLI to full desktop
- **Cross-Platform** - Consistent experience across macOS, Linux (Arch/Ubuntu), and Windows
- **Work-Friendly** - Separate work/personal contexts to handle corporate restrictions
- **Comprehensive Testing** - Docker validates multi-package-manager scenarios

** Key Technologies

- **GNU Stow** - Symlink management for dotfiles deployment
- **Just** - Command runner for consistent cross-platform operations
- **Docker** - Automated testing including multi-package-manager validation
- **Machine Classes** - Package definitions using native package manager formats (Brewfile, packages.txt, requirements.txt)

* Quick Start

** 1. Clone the Repository

Clone to =~/dev/my/dotfiles= (recommended path):

#+begin_src bash
mkdir -p ~/dev/my
git clone --recursive https://github.com/LambertGreen/dotfiles.git ~/dev/my/dotfiles
cd ~/dev/my/dotfiles
#+end_src

** 2. Configure Your System

Interactive configuration:

#+begin_src bash
./configure.sh
#+end_src

The script will auto-detect your platform and present available machine classes to choose from.

Available machine classes include:
- ~docker_essential_{arch|ubuntu}~: Minimal containers with basic CLI tools
- ~docker_developer_{arch|ubuntu}~: Development containers with multiple package managers
- ~laptop_personal_mac~: Personal MacBook with full development setup
- ~laptop_work_mac~: Work MacBook with enterprise-appropriate tools
- ~desktop_{gaming_win|home_ubuntu|work_win}~: Desktop systems with GUI applications
- ~wsl_work_ubuntu~: Windows Subsystem for Linux development environment

Each machine class defines specific package lists optimized for that use case.

Configuration is saved to =.dotfiles.env= for future use.

** 3. Bootstrap Your System

Install essential tools and package managers:

#+begin_src bash
./bootstrap.sh
#+end_src

This reads your configuration and installs the appropriate tools (including =just=).

** 4. Deploy Configurations

Deploy dotfiles using the stow system:

#+begin_src bash
just stow
#+end_src

** 5. Install Packages

Install all packages defined in your machine class:

#+begin_src bash
just install-packages
#+end_src

** 6. Verify Setup

Check that everything is configured correctly:

#+begin_src bash
just check-health
#+end_src


* Package Management

After initial setup, the system provides environment-driven package management:

** Package Installation

Install packages using your configured platform and categories:

#+begin_src bash
just install    # Installs packages for your configured platform/categories
#+end_src

This uses your saved configuration (DOTFILES_PLATFORM and category flags) to install the appropriate packages.

** System Updates

Keep your system and packages up to date with a two-step process:

*** Check for Available Updates

First, update package manager registries and see what's available:

#+begin_src bash
just update-check     # Refreshes package lists and shows available updates
#+end_src

This is a safe, read-only operation that:
- Updates package manager registries (brew update, apt update, etc.)
- Shows which packages have newer versions available
- Does NOT install anything

*** Upgrade Packages

After reviewing available updates, upgrade when ready:

#+begin_src bash
just update-upgrade   # Actually upgrades all packages
#+end_src

This will:
- Prompt for confirmation before proceeding
- Upgrade all packages for your configured platform
- Clean up old versions where appropriate

*** Platform-Specific Update Tools

For more granular control over updates:

#+begin_src bash
just updates    # Opens platform-specific update sub-shell
#+end_src

This gives you access to individual update commands (brew-update, mas-update, etc.) for selective upgrading.

* Platform-Specific Notes

** macOS
- Uses Homebrew as primary package manager (brew/cask)
- GUI apps available in GUI_APPS categories
- Emacs via homebrew tap (emacs-plus@31)
- Platform-specific configs: git_osx, shell_osx, gnupg_osx

** Linux (Arch/Ubuntu)
- Arch: pacman (core) + AUR via yay helper
- Ubuntu: apt (core) + Homebrew Linux (additional packages)
- Emacs via AUR (emacs-plus) on Arch, apt on Ubuntu
- Platform-specific configs: git_linux, shell_linux, gnupg_linux

** Windows
- Scoop as primary package manager
- MSYS2 for Unix-like environment and additional packages
- Limited GUI application support
- Platform-specific configs: git_win, shell_msys2, gnupg_win

* Health Check

The health check tool validates your dotfiles setup:

#+begin_src bash
just check-health
#+end_src

It reports:
- Total symlinks managed by stow
- Any broken symlinks that need attention
- Overall system health status

** Cleaning Broken Links

Preview what would be removed:

#+begin_src bash
just cleanup-broken-links
#+end_src

Actually remove broken links:

#+begin_src bash
just cleanup-broken-links --remove
#+end_src

* Common Tasks

** Update Package Lists

The configuration system manages packages via machine class directories in `machine-classes/`. Each machine class contains package manager-specific files using native formats. To add new packages:

1. Identify the appropriate machine class (e.g., `docker_developer_ubuntu`, `laptop_personal_mac`)
2. Navigate to the appropriate package manager directory
3. Edit the package manager's native format file

Examples:
#+begin_src bash
# For apt packages (Ubuntu)
echo "your-new-package" >> machine-classes/docker_developer_ubuntu/apt/packages.txt

# For Homebrew (macOS/Linux)
echo 'brew "your-new-package"' >> machine-classes/laptop_personal_mac/brew/Brewfile

# For pacman (Arch)
echo "your-new-package" >> machine-classes/docker_developer_arch/pacman/packages.txt
#+end_src

** Restow Configurations

If you've modified configs, restow to update symlinks:

#+begin_src bash
just stow    # Uses your configured platform automatically
#+end_src

** Show Current Configuration

View your current configuration settings:

#+begin_src bash
just show-config
#+end_src

* Troubleshooting

** Permission Denied Errors
- Ensure you have sudo access for bootstrap phase
- Package installation may require admin privileges

** Symlink Conflicts
- Use health check to identify issues
- Remove conflicting files or use force install
- Common conflicts: =.bashrc=, =.zshrc= from system defaults

** Work Machine Restrictions
- Configure only the components you need on work machines
- GUI applications may require admin access on some systems
- Advanced window managers and system tools are in advanced categories for optional installation


* Contributing

1. Make changes in appropriate config directory (`configs/common/`, `configs/osx_only/`, etc.)
2. Test using Docker test infrastructure: `cd test && just test-developer-arch`
3. Run health check to verify changes: `just check-health`
4. Update machine class package lists if adding new packages
5. Submit PR with description of changes

For more detailed information, see the comprehensive setup guide in [[file:README.old.org][README.old.org]].
