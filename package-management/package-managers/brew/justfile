#!/usr/bin/env just --justfile
# Homebrew Package Manager Commands
# Documentation and execution for brew/cask/mas operations

set shell := ["bash", "-uc"]

# Default: show available commands
default:
    @echo "ğŸº Homebrew Package Manager"
    @echo ""
    @echo "ğŸ“¦ Basic Operations:"
    @echo "  just install           # Install packages from current machine class"
    @echo "  just check             # Check for outdated packages"
    @echo "  just upgrade           # Upgrade all packages"
    @echo "  just clean             # Clean up caches and old versions"
    @echo ""
    @echo "ğŸ“‹ Information:"
    @echo "  just list              # List installed packages"
    @echo "  just search <package>  # Search for packages"
    @echo "  just info <package>    # Get package information"
    @echo ""
    @echo "ğŸ”§ Advanced:"
    @echo "  just export            # Export current packages to Brewfile"
    @echo "  just fix-links         # Fix broken symlinks"
    @echo "  just doctor            # Run brew doctor"
    @echo ""
    @echo "ğŸ’¡ Cask Operations:"
    @echo "  just cask-list         # List installed casks"
    @echo "  just cask-search <app> # Search for applications"

# Install packages from current machine class
install:
    @if [[ -f ~/.dotfiles.env ]]; then \
        source ~/.dotfiles.env; \
        brewfile="$(pwd)/../../machines/$DOTFILES_MACHINE_CLASS/brew/Brewfile"; \
        if [[ -f "$brewfile" ]]; then \
            echo "ğŸº Installing packages from: $brewfile"; \
            brew bundle install --file="$brewfile" --no-upgrade; \
        else \
            echo "âŒ No Brewfile found for machine class: $DOTFILES_MACHINE_CLASS"; \
        fi; \
    else \
        echo "âŒ Configuration not found. Run: just configure"; \
    fi

# Check for outdated packages
check:
    @echo "ğŸ” Checking for outdated Homebrew packages..."
    @brew outdated || echo "âœ… All packages are up to date"
    @echo ""
    @echo "ğŸ” Checking for outdated casks..."
    @brew outdated --cask || echo "âœ… All casks are up to date"

# Upgrade all packages
upgrade:
    @echo "ğŸ”„ Upgrading Homebrew packages..."
    @if brew update --quiet 2>/dev/null; then \
        echo "âœ… Repository updated"; \
    else \
        echo "âš ï¸  Update locked, continuing with existing data..."; \
    fi
    @brew upgrade --quiet
    @brew cleanup --quiet
    @echo "âœ… Upgrade complete"

# Clean up caches and old versions
clean:
    @echo "ğŸ§¹ Cleaning Homebrew..."
    @brew cleanup -s
    @brew cleanup --prune=all
    @echo "âœ… Cleanup complete"

# List installed packages
list:
    @echo "ğŸº Installed formulae:"
    @brew leaves | sort
    @echo ""
    @echo "ğŸ“± Installed casks:"
    @brew list --cask | sort

# Search for packages
search package:
    @echo "ğŸ” Searching for: {{package}}"
    @brew search {{package}}

# Get package information  
info package:
    @echo "â„¹ï¸  Information for: {{package}}"
    @brew info {{package}}

# Export current packages to Brewfile
export:
    @echo "ğŸ“¦ Exporting current Homebrew packages..."
    @brew bundle dump --force --describe
    @echo "âœ… Exported to ./Brewfile"
    @echo ""
    @echo "ğŸ’¡ To use this Brewfile:"
    @echo "  brew bundle install --file=./Brewfile"

# Fix broken symlinks
fix-links:
    @echo "ğŸ”§ Fixing broken symlinks..."
    @brew doctor --list-checks | grep -E "(symlink|link)" | xargs -I {} brew doctor --check={}
    @echo "âœ… Link check complete"

# Run brew doctor
doctor:
    @echo "ğŸ¥ Running brew doctor..."
    @brew doctor

# List installed casks
cask-list:
    @echo "ğŸ“± Installed applications (casks):"
    @brew list --cask | sort

# Search for applications
cask-search app:
    @echo "ğŸ” Searching for application: {{app}}"
    @brew search --cask {{app}}

# Common package operations with memorable syntax
install-package package:
    @echo "ğŸº Installing: {{package}}"
    @brew install {{package}}

install-app app:
    @echo "ğŸ“± Installing application: {{app}}"
    @brew install --cask {{app}}

remove-package package:
    @echo "ğŸ—‘ï¸  Removing: {{package}}"
    @brew uninstall {{package}}

remove-app app:
    @echo "ğŸ—‘ï¸  Removing application: {{app}}"
    @brew uninstall --cask {{app}}