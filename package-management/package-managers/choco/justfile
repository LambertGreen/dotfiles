#!/usr/bin/env just --justfile
# Chocolatey Package Manager Commands (Windows)
# Documentation and execution for choco operations
# Chocolatey requires admin privileges for most operations

set shell := ["bash", "-uc"]

# Default: show available commands
default:
    @echo "ğŸ« Chocolatey Package Manager (Windows)"
    @echo ""
    @echo "âš ï¸  Most operations require admin privileges"
    @echo ""
    @echo "ğŸ“¦ Basic Operations:"
    @echo "  just install           # Install packages from current machine class"
    @echo "  just check             # Check for outdated packages"
    @echo "  just upgrade           # Upgrade all packages"
    @echo "  just clean             # Clean up temp files"
    @echo ""
    @echo "ğŸ“‹ Information:"
    @echo "  just list              # List installed packages"
    @echo "  just search <package>  # Search for packages"
    @echo "  just info <package>    # Get package information"
    @echo ""
    @echo "ğŸ”§ Advanced:"
    @echo "  just export            # Export current packages"
    @echo "  just features          # List chocolatey features"
    @echo "  just sources           # List package sources"
    @echo ""
    @echo "ğŸ’¡ Chocolatey Tips:"
    @echo "  - Requires admin for system-wide installs"
    @echo "  - Use --force to reinstall packages"
    @echo "  - Use -y to confirm all prompts"
    @echo "  - Run from WSL or MSYS2 with admin privileges"

# Install packages from current machine class  
install:
    @if [[ -f ~/.dotfiles.env ]]; then \
        source ~/.dotfiles.env; \
        chocofile="$(pwd)/../../machines/$DOTFILES_MACHINE_CLASS/choco/packages.txt"; \
        if [[ -f "$chocofile" ]]; then \
            echo "ğŸ« Installing packages from: $chocofile"; \
            while IFS= read -r package; do \
                if [[ -n "$package" && ! "$package" =~ ^#.* ]]; then \
                    echo "Installing: $package"; \
                    choco install "$package" -y; \
                fi; \
            done < "$chocofile"; \
        else \
            echo "âŒ No packages.txt found for machine class: $DOTFILES_MACHINE_CLASS"; \
        fi; \
    else \
        echo "âŒ Configuration not found. Run: just configure"; \
    fi

# Check for outdated packages
check:
    @echo "ğŸ” Checking for outdated packages..."
    @choco outdated

# Upgrade all packages
upgrade:
    @echo "ğŸ”„ Upgrading all packages..."
    @choco upgrade all -y
    @echo "âœ… Upgrade complete"

# Clean up temp files
clean:
    @echo "ğŸ§¹ Cleaning chocolatey temp files..."
    @if [[ -d "/tmp/chocolatey" ]]; then rm -rf /tmp/chocolatey; fi
    @if [[ -d "$TEMP/chocolatey" ]]; then rm -rf "$TEMP/chocolatey"; fi
    @echo "âœ… Cleanup complete"

# List installed packages
list:
    @echo "ğŸ« Installed packages:"
    @choco list --local-only

# Search for packages
search package:
    @echo "ğŸ” Searching for: {{package}}"
    @choco search {{package}}

# Get package information
info package:
    @echo "â„¹ï¸  Information for: {{package}}"
    @choco info {{package}}

# Export current packages
export:
    @echo "ğŸ“¦ Exporting current packages..."
    @choco list --local-only --id-only > chocolatey-packages.txt
    @echo "âœ… Exported to ./chocolatey-packages.txt"
    @echo ""
    @echo "ğŸ’¡ To install from this list:"
    @echo "  cat chocolatey-packages.txt | while read pkg; do choco install \$pkg -y; done"

# List chocolatey features
features:
    @echo "âš™ï¸  Chocolatey features:"
    @choco feature list

# List package sources
sources:
    @echo "ğŸ“¡ Package sources:"
    @choco source list

# Common package operations
install-package package:
    @echo "ğŸ« Installing: {{package}}"
    @choco install {{package}} -y

remove-package package:
    @echo "ğŸ—‘ï¸  Removing: {{package}}"
    @choco uninstall {{package}} -y

# Force reinstall a package
reinstall-package package:
    @echo "ğŸ”„ Reinstalling: {{package}}"
    @choco install {{package}} --force -y

# Pin a package to prevent upgrades
pin-package package:
    @echo "ğŸ“Œ Pinning package: {{package}}"
    @choco pin add -n={{package}}

# Unpin a package
unpin-package package:
    @echo "ğŸ“Œ Unpinning package: {{package}}"
    @choco pin remove -n={{package}}

# List pinned packages
list-pinned:
    @echo "ğŸ“Œ Pinned packages:"
    @choco pin list

# Update chocolatey itself
update-choco:
    @echo "ğŸ”„ Updating chocolatey..."
    @choco upgrade chocolatey -y

# Show chocolatey configuration
config:
    @echo "âš™ï¸  Chocolatey configuration:"
    @choco config list

# Check chocolatey installation
doctor:
    @echo "ğŸ¥ Checking chocolatey installation..."
    @choco --version
    @echo "Chocolatey location: $(which choco)"