#!/usr/bin/env just --justfile
# NPM Package Manager Commands
# Documentation and execution for Node.js package operations

set shell := ["bash", "-uc"]

# Default: show available commands
default:
    @echo "ğŸ“¦ NPM Package Manager (Node.js)"
    @echo ""
    @echo "ğŸ“¦ Basic Operations:"
    @echo "  just install           # Install global packages from current machine class"
    @echo "  just check             # Check for outdated global packages"
    @echo "  just upgrade           # Upgrade all global packages"
    @echo "  just clean             # Clean npm cache"
    @echo ""
    @echo "ğŸ“‹ Information:"
    @echo "  just list              # List installed global packages"
    @echo "  just search <package>  # Search for packages"
    @echo "  just info <package>    # Get package information"
    @echo ""
    @echo "ğŸ”§ Advanced:"
    @echo "  just export            # Export current global packages"
    @echo "  just doctor            # Run npm doctor"
    @echo "  just audit             # Run security audit"
    @echo ""
    @echo "ğŸ’¡ NPM Tips:"
    @echo "  - Global packages install CLI tools"
    @echo "  - Use 'npx' to run packages without installing"
    @echo "  - Local packages go in package.json"

# Install global packages from current machine class
install:
    @if [[ -f ~/.dotfiles.env ]]; then \
        source ~/.dotfiles.env; \
        packages_file="$(pwd)/../../machines/$DOTFILES_MACHINE_CLASS/npm/packages.txt"; \
        if [[ -f "$packages_file" ]]; then \
            echo "ğŸ“¦ Installing global packages from: $packages_file"; \
            while IFS= read -r package; do \
                if [[ -n "$package" && ! "$package" =~ ^#.* ]]; then \
                    echo "Installing: $package"; \
                    npm install -g "$package"; \
                fi; \
            done < "$packages_file"; \
        else \
            echo "âŒ No packages.txt found for machine class: $DOTFILES_MACHINE_CLASS"; \
        fi; \
    else \
        echo "âŒ Configuration not found. Run: just configure"; \
    fi

# Check for outdated global packages
check:
    @echo "ğŸ” Checking for outdated global packages..."
    @npm outdated -g || echo "âœ… All global packages are up to date"

# Upgrade all global packages
upgrade:
    @echo "ğŸ”„ Upgrading all global packages..."
    @npm update -g
    @echo "âœ… Upgrade complete"

# Clean npm cache
clean:
    @echo "ğŸ§¹ Cleaning npm cache..."
    @npm cache clean --force
    @echo "âœ… Cache cleaned"

# List installed global packages
list:
    @echo "ğŸ“¦ Installed global packages:"
    @npm list -g --depth=0 2>/dev/null | grep -v "â”œâ”€â”€\|â””â”€â”€" | tail -n +2 || echo "No global packages installed"

# Search for packages
search package:
    @echo "ğŸ” Searching for: {{package}}"
    @npm search {{package}}

# Get package information
info package:
    @echo "â„¹ï¸  Information for: {{package}}"
    @npm info {{package}}

# Export current global packages
export:
    @echo "ğŸ“¦ Exporting current global packages..."
    @npm list -g --depth=0 --parseable 2>/dev/null | grep -v "/npm$" | sed 's/.*\///' > npm-packages.txt
    @echo "âœ… Exported to ./npm-packages.txt"
    @echo ""
    @echo "ğŸ’¡ To install from this list:"
    @echo "  cat npm-packages.txt | xargs npm install -g"

# Run npm doctor
doctor:
    @echo "ğŸ¥ Running npm doctor..."
    @npm doctor

# Run security audit
audit:
    @echo "ğŸ” Running security audit..."
    @npm audit

# Common package operations
install-package package:
    @echo "ğŸ“¦ Installing globally: {{package}}"
    @npm install -g {{package}}

remove-package package:
    @echo "ğŸ—‘ï¸  Removing global package: {{package}}"
    @npm uninstall -g {{package}}

# Update npm itself
update-npm:
    @echo "ğŸ”„ Updating npm..."
    @npm install -g npm@latest

# Show npm configuration
config:
    @echo "âš™ï¸  NPM configuration:"
    @npm config list

# Set npm registry (useful for corporate environments)
set-registry registry:
    @echo "ğŸŒ Setting npm registry to: {{registry}}"
    @npm config set registry {{registry}}

# Reset to default registry
reset-registry:
    @echo "ğŸŒ Resetting to default npm registry..."
    @npm config set registry https://registry.npmjs.org/

# Run package with npx (without installing)
run package *args:
    @echo "ğŸƒ Running {{package}} with npx..."
    @npx {{package}} {{args}}

# Show package scripts (for local packages)
scripts:
    @echo "ğŸ“œ Available scripts:"
    @npm run