# Testing workflows for dotfiles

# Default test platform and level
test_platform := env_var_or_default("DOTFILES_TEST_PLATFORM", "arch")
test_level := env_var_or_default("DOTFILES_TEST_LEVEL", "basic")

# Available Docker platforms and levels
docker_platforms := "arch ubuntu"
docker_levels := "basic typical"

# Show test help
default:
    @echo "ðŸ§ª Dotfiles Testing"
    @echo ""
    @echo "Test stages (each builds on previous):"
    @echo "  1. Bootstrap - Install essential tools (stow, package managers)"
    @echo "  2. Stow      - Deploy configs to proper locations"
    @echo "  3. Install   - Install packages using stowed configs"
    @echo "  4. Update    - Update packages and system"
    @echo "  5. Run       - Interactive shell to test environment"
    @echo ""
    @echo "Stage-specific tests:"
    @echo "  just test-configure [level] [platform] - Test configure stage only"
    @echo "  just test-bootstrap [level] [platform] - Test bootstrap stage only"
    @echo "  just test-stow [level] [platform]      - Test through stow stage"
    @echo "  just test-install [level] [platform]   - Test through install stage"
    @echo "  just test-update [level] [platform]    - Test through update stage"
    @echo "  just test-run [level] [platform]       - Run interactive shell"
    @echo ""
    @echo "Batch tests:"
    @echo "  just test-level [level]                 - Test level across platforms"
    @echo "  just test-platform [platform]          - Test platform across levels"
    @echo "  just test-all                          - Test all combinations"
    @echo ""
    @echo "Configuration Tests (Recommended):"
    @echo "  just test-minimal-arch             - Fast Arch validation"
    @echo "  just test-developer-ubuntu         - Ubuntu developer environment"
    @echo "  just test-all-configurations       - Test configuration system across platforms"
    @echo ""
    @echo "Log Management:"
    @echo "  just show-last-log                 - Show most recent test output"
    @echo "  just list-logs                     - List all available logs"
    @echo "  just show-log <filename>           - Show specific log file"
    @echo ""
    @echo "Legacy Tests:"
    @echo "  just test-update basic arch        - Build and test basic Arch (complete)"
    @echo "  just test-run basic arch           - Interactive shell after update"
    @echo ""
    @echo "Available:"
    @echo "  Platforms: {{docker_platforms}}"
    @echo "  Levels: {{docker_levels}}"
    @echo "  Defaults: {{test_level}} {{test_platform}}"

# Test through install stage (complete workflow)
@test-install level=test_level platform=test_platform:
    echo "ðŸ³ Testing {{level}} {{platform}} install stage with Docker..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ“ Logging to test-install-{{level}}-{{platform}}-output.log"
    just test-install-local {{level}} {{platform}} 2>&1 | tee test-install-{{level}}-{{platform}}-output.log; \
    if [ ${PIPESTATUS[0]} -eq 0 ]; then \
        echo "âœ… {{level}} {{platform}} install test PASSED"; \
    else \
        echo "âŒ {{level}} {{platform}} install test FAILED"; \
        echo "ðŸ“„ Check test-install-{{level}}-{{platform}}-output.log for details"; \
    fi

# Test through stow stage only
@test-stow level=test_level platform=test_platform:
    echo "ðŸ³ Testing {{level}} {{platform}} stow stage with Docker..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ“ Logging to test-stow-{{level}}-{{platform}}-output.log"
    just test-stow-local {{level}} {{platform}} 2>&1 | tee test-stow-{{level}}-{{platform}}-output.log; \
    if [ ${PIPESTATUS[0]} -eq 0 ]; then \
        echo "âœ… {{level}} {{platform}} stow test PASSED"; \
    else \
        echo "âŒ {{level}} {{platform}} stow test FAILED"; \
        echo "ðŸ“„ Check test-stow-{{level}}-{{platform}}-output.log for details"; \
    fi

# Test through update stage (complete workflow)
@test-update level=test_level platform=test_platform:
    echo "ðŸ³ Testing {{level}} {{platform}} update stage with Docker..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ“ Logging to test-update-{{level}}-{{platform}}-output.log"
    just test-update-local {{level}} {{platform}} 2>&1 | tee test-update-{{level}}-{{platform}}-output.log; \
    if [ ${PIPESTATUS[0]} -eq 0 ]; then \
        echo "âœ… {{level}} {{platform}} update test PASSED"; \
    else \
        echo "âŒ {{level}} {{platform}} update test FAILED"; \
        echo "ðŸ“„ Check test-update-{{level}}-{{platform}}-output.log for details"; \
    fi

# Run interactive shell after update stage
test-run level=test_level platform=test_platform:
    @echo "ðŸ³ Running {{level}} {{platform}} interactive shell..."
    @echo "Building image to update stage first..."
    cd .. && docker build --build-arg TZ=$(readlink /etc/localtime | sed 's|.*/zoneinfo/||' 2>/dev/null || date +%Z 2>/dev/null || echo "UTC") -f test/dockerfiles/Dockerfile.{{platform}}.multi --target update-{{level}} -t dotfiles-test-{{level}}-{{platform}} .
    @echo "ðŸš€ Starting interactive shell (type 'exit' to return)..."
    docker run -it --rm dotfiles-test-{{level}}-{{platform}}

# Backward compatibility alias (now uses complete workflow)
test level=test_level platform=test_platform: (test-update level platform)

# Helper: Test through install stage (complete workflow)
test-install-local level platform:
    @echo "ðŸ”¨ Building Docker image for {{level}} {{platform}} install stage..."
    cd .. && docker build --build-arg TZ=$(readlink /etc/localtime | sed 's|.*/zoneinfo/||' 2>/dev/null || date +%Z 2>/dev/null || echo "UTC") -f test/dockerfiles/Dockerfile.{{platform}}.multi --target install-{{level}} -t dotfiles-test-{{level}}-{{platform}} .
    @echo "ðŸš€ Running test container..."
    docker run --rm dotfiles-test-{{level}}-{{platform}}

# Helper: Test through stow stage only
test-stow-local level platform:
    @echo "ðŸ”¨ Building Docker image for {{level}} {{platform}} stow stage..."
    cd .. && docker build --build-arg TZ=$(readlink /etc/localtime | sed 's|.*/zoneinfo/||' 2>/dev/null || date +%Z 2>/dev/null || echo "UTC") -f test/dockerfiles/Dockerfile.{{platform}}.multi --target stow-{{level}} -t dotfiles-stow-{{level}}-{{platform}} .
    @echo "ðŸš€ Running test container..."
    docker run --rm dotfiles-stow-{{level}}-{{platform}}

# Helper: Test through update stage (complete workflow)
test-update-local level platform:
    @echo "ðŸ”¨ Building Docker image for {{level}} {{platform}} update stage..."
    cd .. && docker build --build-arg TZ=$(readlink /etc/localtime | sed 's|.*/zoneinfo/||' 2>/dev/null || date +%Z 2>/dev/null || echo "UTC") -f test/dockerfiles/Dockerfile.{{platform}}.multi --target update-{{level}} -t dotfiles-test-{{level}}-{{platform}} .
    @echo "ðŸš€ Running test container..."
    docker run --rm dotfiles-test-{{level}}-{{platform}}

# Test configure only (configuration generation)
test-configure level platform:
    @echo "ðŸ”§ Building configure-only Docker image for {{level}} {{platform}}..."
    cd .. && docker build --build-arg TZ=$(readlink /etc/localtime | sed 's|.*/zoneinfo/||' 2>/dev/null || date +%Z 2>/dev/null || echo "UTC") -f test/dockerfiles/Dockerfile.{{platform}}.multi --target configure -t dotfiles-configure-{{level}}-{{platform}} .
    @echo "ðŸš€ Running configure test container..."
    docker run --rm dotfiles-configure-{{level}}-{{platform}}

# Test bootstrap only (no package installation)
test-bootstrap level platform:
    @echo "ðŸ”¨ Building bootstrap-only Docker image for {{level}} {{platform}}..."
    cd .. && docker build --build-arg TZ=$(readlink /etc/localtime | sed 's|.*/zoneinfo/||' 2>/dev/null || date +%Z 2>/dev/null || echo "UTC") -f test/dockerfiles/Dockerfile.{{platform}}.multi --target bootstrap-{{level}} -t dotfiles-bootstrap-{{level}}-{{platform}} .
    @echo "ðŸš€ Running bootstrap test container..."
    docker run --rm dotfiles-bootstrap-{{level}}-{{platform}}

# Test with GitHub (full integration test)
test-remote platform:
    @echo "ðŸ”¨ Building Docker image for {{platform}} (GitHub integration)..."
    docker build \
        -f dockerfiles/Dockerfile.{{platform}} \
        -t dotfiles-test-{{platform}} .
    @echo "ðŸš€ Running integration test container..."
    docker run --rm dotfiles-test-{{platform}}

# Test specific level across all platforms
@test-level level:
    echo "ðŸ§ª Testing {{level}} across all platforms: {{docker_platforms}}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ“ Logging to test-level-{{level}}-output.log"
    -just test-update {{level}} arch 2>&1 | tee -a test-level-{{level}}-output.log
    -just test-update {{level}} ubuntu 2>&1 | tee -a test-level-{{level}}-output.log
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ {{level}} level tests completed"
    echo "ðŸ“„ Full log available in test-level-{{level}}-output.log"

# Test specific platform across all levels
@test-platform platform:
    echo "ðŸ§ª Testing {{platform}} across all levels: {{docker_levels}}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ“ Logging to test-platform-{{platform}}-output.log"
    -just test-update basic {{platform}} 2>&1 | tee -a test-platform-{{platform}}-output.log
    -just test-update typical {{platform}} 2>&1 | tee -a test-platform-{{platform}}-output.log
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ {{platform}} platform tests completed"
    echo "ðŸ“„ Full log available in test-platform-{{platform}}-output.log"

# Test all combinations
@test-all:
    echo "ðŸ§ª Testing all combinations"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ“ Logging to test-all-output.log"
    -just test-update basic arch 2>&1 | tee -a test-all-output.log
    -just test-update basic ubuntu 2>&1 | tee -a test-all-output.log
    -just test-update typical arch 2>&1 | tee -a test-all-output.log
    -just test-update typical ubuntu 2>&1 | tee -a test-all-output.log
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ All combination tests completed"
    echo "ðŸ“„ Full log available in test-all-output.log"

# Show git status
@status:
    echo "ðŸ“Š Repository Status"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    cd .. && git status --short
    echo ""
    echo "ðŸ“¦ Submodules:"
    cd .. && git submodule status

# Show the most recent test log
@show-last-log:
    echo "ðŸ“„ Most recent test log:"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    ls -t *-output.log 2>/dev/null | head -1 | xargs -I {} sh -c 'echo "ðŸ“ File: {}" && echo "" && tail -50 {}'

# Show all available test logs
@list-logs:
    echo "ðŸ“„ Available test logs:"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    ls -lt *-output.log 2>/dev/null || echo "No log files found"

# Show specific log file (usage: just show-log filename)
@show-log file:
    echo "ðŸ“„ Showing log: {{file}}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    tail -100 {{file}}

# Update submodules
update:
    cd .. && git submodule update --init --recursive

# Validate everything
@validate:
    echo "ðŸ” Running validations..."
    just test-all
    echo "âœ… All validations passed"

# =====================================
# Configuration Testing
# =====================================

# Test minimal configuration on Arch Linux
@test-minimal-arch:
    echo "ðŸ§ª Testing minimal configuration on Arch Linux..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ“ Logging to test-minimal-arch-output.log"
    docker build --build-arg TZ=$(readlink /etc/localtime | sed 's|.*/zoneinfo/||' 2>/dev/null || date +%Z 2>/dev/null || echo "UTC") -f dockerfiles/Dockerfile.arch.multi --target update-basic .. 2>&1 | tee test-minimal-arch-output.log; \
    if [ ${PIPESTATUS[0]} -eq 0 ]; then \
        echo "âœ… Minimal Arch test PASSED"; \
    else \
        echo "âŒ Minimal Arch test FAILED"; \
        echo "ðŸ“„ Check test-minimal-arch-output.log for details"; \
        exit 1; \
    fi

# Removed platform-specific test recipes - use existing level/platform structure instead

# Test developer configuration on Ubuntu
@test-developer-ubuntu:
    echo "ðŸ§ª Testing developer configuration on Ubuntu..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ“ Logging to test-developer-ubuntu-output.log"
    docker build --build-arg TZ=$(readlink /etc/localtime | sed 's|.*/zoneinfo/||' 2>/dev/null || date +%Z 2>/dev/null || echo "UTC") -f dockerfiles/Dockerfile.ubuntu.multi --target update-basic .. 2>&1 | tee test-developer-ubuntu-output.log; \
    if [ ${PIPESTATUS[0]} -eq 0 ]; then \
        echo "âœ… Developer Ubuntu test PASSED"; \
    else \
        echo "âŒ Developer Ubuntu test FAILED"; \
        echo "ðŸ“„ Check test-developer-ubuntu-output.log for details"; \
        exit 1; \
    fi

# Test configuration system across platforms
@test-all-configurations:
    echo "ðŸ§ª Testing configuration system across platforms"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ“ Logging to test-all-configurations-output.log"
    -just test-minimal-arch 2>&1 | tee -a test-all-configurations-output.log
    -just test-developer-ubuntu 2>&1 | tee -a test-all-configurations-output.log
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ Configuration tests completed"
    echo "ðŸ“„ Full log available in test-all-configurations-output.log"

# Interactive shell for debugging (minimal Arch)
@test-shell-arch:
    echo "ðŸš Interactive shell - Arch minimal configuration"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ”§ Building container and dropping into shell..."
    docker build --build-arg TZ=$(readlink /etc/localtime | sed 's|.*/zoneinfo/||' 2>/dev/null || date +%Z 2>/dev/null || echo "UTC") -f dockerfiles/Dockerfile.arch.multi --target install-basic .. && \
    docker run -it $$(docker build -q -f dockerfiles/Dockerfile.arch.multi --target install-basic ..) /bin/bash

# Interactive shell for debugging (developer Ubuntu)  
@test-shell-ubuntu:
    echo "ðŸš Interactive shell - Ubuntu developer configuration"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ”§ Building container and dropping into shell..."
    docker build --build-arg TZ=$(readlink /etc/localtime | sed 's|.*/zoneinfo/||' 2>/dev/null || date +%Z 2>/dev/null || echo "UTC") -f dockerfiles/Dockerfile.ubuntu.multi --target install-basic .. && \
    docker run -it $$(docker build -q -f dockerfiles/Dockerfile.ubuntu.multi --target install-basic ..) /bin/bash