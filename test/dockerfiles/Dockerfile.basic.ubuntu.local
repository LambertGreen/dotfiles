FROM ubuntu:24.04

# Install minimal packages for dotfiles testing + realistic system defaults
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    sudo git openssh-client stow make curl ca-certificates \
    bash zsh locales && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/*

# Set up locale
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV LC_ALL=en_US.UTF-8

# Install Just
RUN curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Create a test user (Note: we need to give the user an explicit uid, since we need to reference it
# in the ssh mount command.)
RUN useradd -u 100 --create-home --shell /bin/bash --comment "Ubuntu dotfiles user" user && \
    usermod -aG sudo user  # Grant sudo to the user

# Add user to sudoers
RUN echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# Set user's password to 'user'
RUN echo 'user:user' | chpasswd
USER user
ENV HOME=/home/user

# Create directory structure
RUN mkdir -p ~/dev/my/dotfiles

# Bootstrap phase - install required tools (cacheable, independent)
COPY --chown=user:user bootstrap/ /home/user/dev/my/dotfiles/bootstrap/
WORKDIR /home/user/dev/my/dotfiles/bootstrap
RUN echo "ðŸš€ Running bootstrap phase..." && \
    just bootstrap-basic-ubuntu

# Package installation phase - run standard workflows
COPY --chown=user:user configs/package_management/ /home/user/dev/my/dotfiles/configs/package_management/
COPY --chown=user:user configs/package_management_ubuntu/ /home/user/dev/my/dotfiles/configs/package_management_ubuntu/
WORKDIR /home/user/dev/my/dotfiles/configs/package_management_ubuntu/dot-package_management/install
RUN echo "ðŸ“¦ Running package installation phase..." && \
    just install-test

# Copy the rest of the dotfiles (this layer will be invalidated on most changes, but expensive work is cached)
COPY --chown=user:user . /home/user/dev/my/dotfiles

# Run stowing and health check validation
WORKDIR /home/user/dev/my/dotfiles/configs
RUN echo "ðŸ”— Running basic stowing..." && \
    just ubuntu stow-basic

# Validate the setup worked
WORKDIR /home/user/dev/my/dotfiles
RUN echo "ðŸ§ª Validating setup with health check..." && \
    test -d ~/.package_management && \
    cd ~/.package_management/install && \
    just --list > /dev/null && \
    echo "ðŸ“‹ Running dotfiles health check..." && \
    just health-check && \
    echo "âœ… Dotfiles test completed successfully"

# Run a bash instance for manual testing: user should validate apps run fine before and after unstowing
CMD ["/bin/bash"]