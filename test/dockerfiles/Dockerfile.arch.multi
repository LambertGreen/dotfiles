# Multi-stage Dockerfile for Arch dotfiles testing
# Tests complete workflow: configure ‚Üí bootstrap ‚Üí stow ‚Üí install ‚Üí update

# =============================================================================
# BASE STAGE - Common system setup for all Arch tests
# =============================================================================
FROM --platform=linux/amd64 archlinux:latest AS base

# Install minimal system packages only - let bootstrap scripts handle the rest
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm git curl wget sudo base-devel tzdata && \
    # Set timezone to PST for easy time comparison
    ln -sf /usr/share/zoneinfo/America/Los_Angeles /etc/localtime && \
    echo 'America/Los_Angeles' > /etc/timezone && \
    useradd -m -G wheel -s /bin/bash testuser && \
    echo 'testuser ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

USER testuser
WORKDIR /home/testuser
ENV TZ=America/Los_Angeles

# Copy dotfiles into container
COPY --chown=testuser:testuser . dotfiles/
WORKDIR /home/testuser/dotfiles

# =============================================================================
# CONFIGURE STAGE - Interactive configuration
# =============================================================================
FROM base AS configure
RUN echo "=== CONFIGURE STAGE ===" && \
    echo "üïê Configure start time: $(date)" && \
    rm -f .dotfiles.env && \
    printf "2\n1\n1\n" | ./configure.sh --no-autodetect && \
    echo "üìã Generated configuration:" && \
    cat .dotfiles.env && \
    echo "üîç Verifying configuration..." && \
    grep -q "DOTFILES_PLATFORM=arch" .dotfiles.env && \
    grep -q "# Selected: min-cli" .dotfiles.env && \
    echo "‚úÖ Configuration verified!" && \
    echo "üïê Configure end time: $(date)"

# =============================================================================
# BOOTSTRAP STAGE - Tool installation
# =============================================================================
FROM configure AS bootstrap-basic
RUN echo "=== BOOTSTRAP STAGE ===" && \
    echo "üïê Bootstrap start time: $(date)" && \
    echo "üîß Installing essential tools (stow, just)..." && \
    sudo pacman -S --noconfirm stow && \
    curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | sudo bash -s -- --to /usr/local/bin && \
    echo "üè• Health check after bootstrap:" && \
    bash -c "source tools/dotfiles-health/dotfiles-health.sh && dotfiles_health_check || echo '‚ö†Ô∏è  Empty system after bootstrap is expected'" && \
    echo "üîç Verifying tools installed by bootstrap scripts..." && \
    which stow && stow --version && \
    which just && just --version && \
    echo "‚úÖ Bootstrap complete!" && \
    echo "üïê Bootstrap end time: $(date)"

# System supports different configurations via configure script

# =============================================================================
# STOW STAGE - Config deployment
# =============================================================================
FROM bootstrap-basic AS stow-basic
RUN echo "=== STOW STAGE ===" && \
    echo "üîç Showing configuration before stow:" && \
    cat .dotfiles.env && \
    just stow && \
    echo "üè• Health check after stow:" && \
    bash -c "source tools/dotfiles-health/dotfiles-health.sh && dotfiles_health_check || echo '‚ö†Ô∏è  Health check after stow - some configs may not create visible symlinks'" && \
    echo "‚úÖ Stow complete!"

# Typical stage removed - use configure script for selection

# =============================================================================
# INSTALL STAGE - Package installation
# =============================================================================
FROM stow-basic AS install-basic
RUN echo "=== INSTALL STAGE ===" && \
    echo "üìä Showing configuration:" && \
    just show-config && \
    echo "üì¶ Installing packages..." && \
    just install && \
    echo "üè• Health check after install:" && \
    bash -c "source tools/dotfiles-health/dotfiles-health.sh && dotfiles_health_check" && \
    echo "‚úÖ Install complete!"

# Typical install stage removed - use configure script for selection

# =============================================================================
# UPDATE STAGE - Complete workflow
# =============================================================================
FROM install-basic AS update-basic
RUN echo "=== UPDATE STAGE ===" && \
    just update && \
    echo "üè• Final health check:" && \
    bash -c "source tools/dotfiles-health/dotfiles-health.sh && dotfiles_health_check" && \
    echo "üß™ Verifying installed packages:" && \
    which git stow rg && \
    echo "‚úÖ Arch workflow complete!"

# Typical update stage removed - use configure script for selection
# All workflow stages now use unified configuration approach