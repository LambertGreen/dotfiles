# Multi-stage Dockerfile for Arch dotfiles testing
# Tests complete workflow: configure ‚Üí bootstrap ‚Üí stow ‚Üí install ‚Üí update

# =============================================================================
# BASE STAGE - Common system setup for all Arch tests
# =============================================================================
FROM --platform=linux/amd64 archlinux:latest AS base

# Install minimal system packages and required tools
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm git curl wget sudo base-devel tzdata stow zsh && \
    # Install just command runner
    curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin && \
    useradd -m -G wheel -s /bin/bash user && \
    echo 'user ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

USER user
WORKDIR /home/user

# Set timezone from host system (fallback to UTC)
ARG TZ
ENV TZ=${TZ:-UTC}
RUN sudo ln -sf /usr/share/zoneinfo/$TZ /etc/localtime

# Copy dotfiles into container
COPY --chown=user:user . dotfiles/
WORKDIR /home/user/dotfiles

# =============================================================================
# CONFIGURE STAGE - Interactive configuration
# =============================================================================
FROM base AS configure
RUN echo "=== CONFIGURE STAGE ===" && \
    echo "üïê Configure start time: $(date)" && \
    rm -f .dotfiles.env && \
    printf "2\n1\n1\n" | ./configure.sh --no-autodetect && \
    echo "üìã Generated configuration:" && \
    cat .dotfiles.env && \
    echo "üîç Verifying configuration..." && \
    grep -q "DOTFILES_PLATFORM=arch" .dotfiles.env && \
    grep -q "# Selected: min-cli" .dotfiles.env && \
    echo "‚úÖ Configuration verified!" && \
    echo "üïê Configure end time: $(date)"

# =============================================================================
# BOOTSTRAP STAGE - Tool installation
# =============================================================================
FROM configure AS bootstrap-basic
RUN echo "=== BOOTSTRAP STAGE ===" && \
    echo "üïê Bootstrap start time: $(date)" && \
    echo "üîß Essential tools (stow, just) already installed in base stage..." && \
    echo "üè• Health check after bootstrap:" && \
    bash tools/dotfiles-health/dotfiles-health.sh || echo '‚ö†Ô∏è  Empty system after bootstrap is expected' && \
    echo "üîç Verifying tools installed by bootstrap scripts..." && \
    which stow && stow --version && \
    which just && just --version && \
    echo "‚úÖ Bootstrap complete!" && \
    echo "üïê Bootstrap end time: $(date)"

# System supports different configurations via configure script

# =============================================================================
# STOW STAGE - Config deployment
# =============================================================================
FROM bootstrap-basic AS stow-basic
RUN echo "=== STOW STAGE ===" && \
    echo "üîç Showing configuration before stow:" && \
    cat .dotfiles.env && \
    echo "üßπ Removing default shell files that conflict with stow..." && \
    rm -f ~/.bash_profile ~/.bashrc && \
    just stow && \
    echo "üîç Checking what symlinks were created:" && \
    find /home/user -maxdepth 2 -type l | head -10 || echo "No symlinks found" && \
    echo "üè• Health check after stow:" && \
    bash tools/dotfiles-health/dotfiles-health.sh || echo '‚ö†Ô∏è  Health check after stow - some configs may not create visible symlinks' && \
    echo "‚úÖ Stow complete!"

# Typical stage removed - use configure script for selection

# =============================================================================
# INSTALL STAGE - Package installation
# =============================================================================
FROM stow-basic AS install-basic
RUN echo "=== INSTALL STAGE ===" && \
    echo "üìä Showing configuration:" && \
    just show-config && \
    echo "üì¶ Installing packages..." && \
    just install && \
    echo "üè• Health check after install:" && \
    bash tools/dotfiles-health/dotfiles-health.sh && \
    echo "‚úÖ Install complete!"

# Typical install stage removed - use configure script for selection

# =============================================================================
# UPDATE STAGE - Complete workflow
# =============================================================================
FROM install-basic AS update-basic
RUN echo "=== UPDATE STAGE ===" && \
    just update-check && \
    echo "üè• Final health check:" && \
    bash tools/dotfiles-health/dotfiles-health.sh && \
    echo "üß™ Verifying installed packages:" && \
    which git stow && \
    echo "‚úÖ Arch workflow complete!"

# Typical update stage removed - use configure script for selection
# All workflow stages now use unified configuration approach