# Multi-stage Dockerfile for Arch dotfiles testing
# Usage:
#   docker build --target base -t dotfiles-arch-base .
#   docker build --target bootstrap-basic -t dotfiles-arch-bootstrap-basic .
#   docker build --target stow-basic -t dotfiles-arch-stow-basic .
#   docker build --target install-basic -t dotfiles-arch-install-basic .
#   docker build --target update-basic -t dotfiles-arch-update-basic .

# =============================================================================
# BASE STAGE - Common system setup for all Arch tests
# =============================================================================
FROM archlinux/archlinux:base-devel AS base

# Install minimal packages for dotfiles testing + realistic system defaults
RUN pacman --sync --refresh --sysupgrade --noconfirm --noprogressbar --quiet && \
  pacman --sync --noconfirm --noprogressbar --quiet \
    sudo git openssh stow just bash zsh && \
  pacman -Scc --noconfirm && \
  rm -rf /var/cache/pacman/pkg/* /tmp/*

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Create a test user
RUN useradd -u 100 --create-home --comment "Arch dotfiles user" user && \
    usermod -aG wheel user && \
    sed -i /etc/sudoers -re 's/^#includedir.*/## **Removed the include directive** ##"/g' && \
    echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
    echo 'user:user' | chpasswd

USER user
ENV HOME=/home/user

# Create directory structure
RUN mkdir -p ~/dev/my/dotfiles

# =============================================================================
# BOOTSTRAP STAGES - Tool installation by level
# =============================================================================
FROM base AS bootstrap-basic

COPY --chown=user:user bootstrap/ /home/user/dev/my/dotfiles/bootstrap/
WORKDIR /home/user/dev/my/dotfiles/bootstrap

RUN echo "🚀 Running basic bootstrap..." && \
    just bootstrap-basic-arch

# Validate bootstrap
RUN echo "🔍 Validating basic bootstrap..." && \
    command -v yay && \
    echo "✅ Basic bootstrap validation complete"

CMD ["/bin/bash"]

FROM base AS bootstrap-typical

COPY --chown=user:user bootstrap/ /home/user/dev/my/dotfiles/bootstrap/
WORKDIR /home/user/dev/my/dotfiles/bootstrap

RUN echo "🚀 Running typical bootstrap..." && \
    just bootstrap-typical-arch

# Validate bootstrap
RUN echo "🔍 Validating typical bootstrap..." && \
    command -v yay && \
    command -v brew && \
    echo "✅ Typical bootstrap validation complete"

CMD ["/bin/bash"]

FROM base AS bootstrap-max

COPY --chown=user:user bootstrap/ /home/user/dev/my/dotfiles/bootstrap/
WORKDIR /home/user/dev/my/dotfiles/bootstrap

RUN echo "🚀 Running max bootstrap..." && \
    just bootstrap-max-arch

# Validate bootstrap
RUN echo "🔍 Validating max bootstrap..." && \
    command -v yay && \
    command -v brew && \
    command -v nix && \
    echo "✅ Max bootstrap validation complete"

CMD ["/bin/bash"]

# =============================================================================
# STOW STAGES - Config deployment by level
# =============================================================================
FROM bootstrap-basic AS stow-basic

# Add all configs for stowing
COPY --chown=user:user configs/ /home/user/dev/my/dotfiles/configs/
COPY --chown=user:user justfile /home/user/dev/my/dotfiles/justfile
COPY --chown=user:user tools/ /home/user/dev/my/dotfiles/tools/

# Run stow via platform-specific justfile
WORKDIR /home/user/dev/my/dotfiles/configs
RUN echo "🔗 Running basic stow..." && \
    just -f justfile_arch stow-basic

# Validate the stow setup worked
WORKDIR /home/user/dev/my/dotfiles
RUN echo "🧪 Validating basic stow with health check..." && \
    test -d ~/.package_management && \
    cd ~/.package_management/install && \
    just --list > /dev/null && \
    echo "📋 Running dotfiles health check..." && \
    cd /home/user/dev/my/dotfiles && \
    just health-check && \
    echo "✅ Basic stow validation completed successfully"

CMD ["/bin/bash"]

FROM bootstrap-typical AS stow-typical

# Add all configs for stowing
COPY --chown=user:user configs/ /home/user/dev/my/dotfiles/configs/
COPY --chown=user:user justfile /home/user/dev/my/dotfiles/justfile
COPY --chown=user:user tools/ /home/user/dev/my/dotfiles/tools/

# Run stow via platform-specific justfile
WORKDIR /home/user/dev/my/dotfiles/configs
RUN echo "🔗 Running typical stow..." && \
    just -f justfile_arch stow-typical

# Validate the stow setup worked
WORKDIR /home/user/dev/my/dotfiles
RUN echo "🧪 Validating typical stow with health check..." && \
    test -d ~/.package_management && \
    cd ~/.package_management/install && \
    just --list > /dev/null && \
    echo "📋 Running dotfiles health check..." && \
    cd /home/user/dev/my/dotfiles && \
    just health-check && \
    echo "✅ Typical stow validation completed successfully"

CMD ["/bin/bash"]

# =============================================================================
# INSTALL STAGES - Package installation by level
# =============================================================================
FROM stow-basic AS install-basic

# Run install via package management justfile (from stowed location)
RUN echo "📦 Running basic install..." && \
    cd ~/.package_management/install && \
    just install-basic

CMD ["/bin/bash"]

FROM stow-typical AS install-typical

# Run install via package management justfile (from stowed location)
RUN echo "📦 Running typical install..." && \
    cd ~/.package_management/install && \
    just install-typical

CMD ["/bin/bash"]

# =============================================================================
# UPDATE STAGES - Complete workflow (bootstrap + stow + install + update)
# =============================================================================
FROM install-basic AS update-basic

# Run update via package management justfile (from stowed location)
RUN echo "🔄 Running basic update..." && \
    cd ~/.package_management/update && \
    just update-basic

CMD ["/bin/bash"]

FROM install-typical AS update-typical

# Run update via package management justfile (from stowed location)
RUN echo "🔄 Running typical update..." && \
    cd ~/.package_management/update && \
    just update-typical

CMD ["/bin/bash"]