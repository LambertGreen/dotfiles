# Category-Based Package Management Test - Arch Linux
# Tests complete workflow: configure â†’ bootstrap â†’ stow â†’ install â†’ update
# Uses category system with area-based configuration

FROM --platform=linux/amd64 archlinux:latest AS base

# Install essential packages for dotfiles setup
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm git curl wget sudo base-devel && \
    # Install newer just version that supports import
    curl -L https://github.com/casey/just/releases/download/1.36.0/just-1.36.0-x86_64-unknown-linux-musl.tar.gz | tar -xz -C /usr/local/bin && \
    useradd -m -G wheel -s /bin/bash testuser && \
    echo 'testuser ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

USER testuser
WORKDIR /home/testuser

# Copy dotfiles into container
COPY --chown=testuser:testuser . dotfiles/
WORKDIR /home/testuser/dotfiles

# Stage 1: Configure with area-based system (minimal profile)
FROM base AS configure
RUN echo "=== CONFIGURE STAGE ===" && \
    rm -f .dotfiles.env && \
    printf "2\n1\n1\n" | ./configure-p1p2.sh --no-autodetect && \
    echo "ğŸ“‹ Generated configuration:" && \
    cat .dotfiles.env

# Stage 2: Bootstrap (install just and basic tools)
FROM configure AS bootstrap  
RUN echo "=== BOOTSTRAP STAGE ===" && \
    ./bootstrap.sh && \
    echo "ğŸ¥ Health check after bootstrap:" && \
    bash -c "source tools/dotfiles-health/dotfiles-health.sh && dotfiles_health_check || echo 'âš ï¸  Empty system after bootstrap is expected'"

# Stage 3: Stow configurations
FROM bootstrap AS stow
RUN echo "=== STOW STAGE ===" && \
    just stow && \
    echo "ğŸ¥ Health check after stow:" && \
    bash -c "source tools/dotfiles-health/dotfiles-health.sh && dotfiles_health_check || echo 'âš ï¸  Health check after stow - some configs may not create visible symlinks'"

# Stage 4: Install packages using category system  
FROM stow AS install
RUN echo "=== INSTALL STAGE ===" && \
    echo "ğŸ“Š Showing configuration:" && \
    just show-config && \
    echo "ğŸ“¦ Installing packages..." && \
    just install && \
    echo "ğŸ¥ Health check after install:" && \
    bash -c "source tools/dotfiles-health/dotfiles-health.sh && dotfiles_health_check"

# Stage 5: Update packages
FROM install AS update
RUN echo "=== UPDATE STAGE ===" && \
    just update && \
    echo "ğŸ¥ Final health check:" && \
    bash -c "source tools/dotfiles-health/dotfiles-health.sh && dotfiles_health_check" && \
    echo "âœ… Arch workflow complete!"

# Final verification stage
FROM update AS verify
RUN echo "=== VERIFICATION STAGE ===" && \
    echo "ğŸ“Š Final configuration:" && \
    just show-config && \
    echo "ğŸ§ª Verifying installed packages:" && \
    which git stow vim && \
    echo "âœ… Arch Linux test successful!"
