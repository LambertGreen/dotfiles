# Multi-stage Dockerfile for Ubuntu dotfiles testing
# Tests complete workflow: configure â†’ bootstrap â†’ stow â†’ install â†’ update

# =============================================================================
# BASE STAGE - Common system setup for all Ubuntu tests
# =============================================================================
FROM ubuntu:22.04 AS base

# Install only minimal system requirements, then use real bootstrap scripts
RUN apt-get update --quiet && \
    DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
      sudo git openssh-client wget curl ca-certificates build-essential \
      bash zsh && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    useradd -u 1000 --create-home --comment "Ubuntu dotfiles user" user && \
    usermod -aG sudo user && \
    echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
    echo 'user:user' | chpasswd

# No additional tools needed - bootstrap.sh will handle everything

USER user
WORKDIR /home/user

# Set timezone from host system (fallback to UTC)
ARG TZ
ENV TZ=${TZ:-UTC}
RUN sudo ln -sf /usr/share/zoneinfo/$TZ /etc/localtime

# Copy only essential files first for better caching
WORKDIR /home/user/dotfiles

# =============================================================================
# CONFIGURE STAGE - Interactive configuration
# =============================================================================
FROM base AS configure
# Copy only configuration script for configure stage
COPY --chown=user:user configure.sh ./
RUN echo "=== CONFIGURE STAGE ===" && \
    echo "ðŸ• Configure start time: $(date)" && \
    rm -f ~/.dotfiles.env && \
    printf "3\n1\n1\ny\n" | ./configure.sh --no-autodetect && \
    echo "ðŸ“‹ Generated configuration:" && \
    cat ~/.dotfiles.env && \
    echo "ðŸ” Verifying configuration..." && \
    grep -q "DOTFILES_PLATFORM=ubuntu" ~/.dotfiles.env && \
    grep -q "# Selected: min-cli" ~/.dotfiles.env && \
    echo "âœ… Configuration verified!" && \
    echo "ðŸ• Configure end time: $(date)"

# =============================================================================
# BOOTSTRAP STAGE - Tool installation
# =============================================================================
# Tier 1: min-cli configuration
FROM base AS configure-min-cli
# Copy only configuration script for configure stage
COPY --chown=user:user configure.sh ./
RUN echo "=== CONFIGURE min-cli STAGE ===" && \
    echo "ðŸ• Configure start time: $(date)" && \
    rm -f ~/.dotfiles.env && \
    printf "3\n1\n1\ny\n" | ./configure.sh --no-autodetect && \
    echo "ðŸ“‹ Generated configuration:" && \
    cat ~/.dotfiles.env && \
    echo "ðŸ” Verifying configuration..." && \
    grep -q "DOTFILES_PLATFORM=ubuntu" ~/.dotfiles.env && \
    grep -q "# Selected: min-cli" ~/.dotfiles.env && \
    echo "âœ… Configuration verified!" && \
    echo "ðŸ• Configure end time: $(date)"

# Tier 2: mid-cli configuration
FROM base AS configure-mid-cli
# Copy only configuration script for configure stage
COPY --chown=user:user configure.sh ./
RUN echo "=== CONFIGURE mid-cli STAGE ===" && \
    echo "ðŸ• Configure start time: $(date)" && \
    rm -f ~/.dotfiles.env && \
    printf "3\n1\n2\ny\n" | ./configure.sh --no-autodetect && \
    echo "ðŸ“‹ Generated configuration:" && \
    cat ~/.dotfiles.env && \
    echo "ðŸ” Verifying configuration..." && \
    grep -q "DOTFILES_PLATFORM=ubuntu" ~/.dotfiles.env && \
    grep -q "# Selected: mid-cli" ~/.dotfiles.env && \
    echo "âœ… Configuration verified!" && \
    echo "ðŸ• Configure end time: $(date)"

# Tier 3: mid-dev configuration
FROM base AS configure-mid-dev
# Copy only configuration script for configure stage
COPY --chown=user:user configure.sh ./
RUN echo "=== CONFIGURE mid-dev STAGE ===" && \
    echo "ðŸ• Configure start time: $(date)" && \
    rm -f ~/.dotfiles.env && \
    printf "3\n1\n3\ny\n" | ./configure.sh --no-autodetect && \
    echo "ðŸ“‹ Generated configuration:" && \
    cat ~/.dotfiles.env && \
    echo "ðŸ” Verifying configuration..." && \
    grep -q "DOTFILES_PLATFORM=ubuntu" ~/.dotfiles.env && \
    grep -q "# Selected: mid-dev" ~/.dotfiles.env && \
    echo "âœ… Configuration verified!" && \
    echo "ðŸ• Configure end time: $(date)"

# Tier 4: max-dev configuration
FROM base AS configure-max-dev
# Copy only configuration script for configure stage
COPY --chown=user:user configure.sh ./
RUN echo "=== CONFIGURE max-dev STAGE ===" && \
    echo "ðŸ• Configure start time: $(date)" && \
    rm -f ~/.dotfiles.env && \
    printf "3\n1\n4\ny\n" | ./configure.sh --no-autodetect && \
    echo "ðŸ“‹ Generated configuration:" && \
    cat ~/.dotfiles.env && \
    echo "ðŸ” Verifying configuration..." && \
    grep -q "DOTFILES_PLATFORM=ubuntu" ~/.dotfiles.env && \
    grep -q "# Selected: max-dev" ~/.dotfiles.env && \
    echo "âœ… Configuration verified!" && \
    echo "ðŸ• Configure end time: $(date)"

FROM configure-min-cli AS bootstrap-min-cli
# Copy bootstrap files and health check tools
COPY --chown=user:user bootstrap.sh ./
COPY --chown=user:user bootstrap/ ./bootstrap/
COPY --chown=user:user tools/dotfiles-health/ ./tools/dotfiles-health/
RUN echo "=== BOOTSTRAP min-cli STAGE ===" && \
    echo "ðŸ• Bootstrap start time: $(date)" && \
    echo "ðŸ”§ Running actual bootstrap script for system parity..." && \
    ./bootstrap.sh && \
    echo "ðŸ¥ Health check after bootstrap:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" || echo 'âš ï¸  Empty system after bootstrap is expected' && \
    echo "ðŸ” Verifying tools installed by bootstrap scripts..." && \
    which stow && stow --version && \
    which just && just --version && \
    which python3 && python3 --version && \
    echo "âœ… Bootstrap complete!" && \
    echo "ðŸ• Bootstrap end time: $(date)"

FROM configure-mid-cli AS bootstrap-mid-cli
# Copy bootstrap files and health check tools
COPY --chown=user:user bootstrap.sh ./
COPY --chown=user:user bootstrap/ ./bootstrap/
COPY --chown=user:user tools/dotfiles-health/ ./tools/dotfiles-health/
RUN echo "=== BOOTSTRAP mid-cli STAGE ===" && \
    echo "ðŸ• Bootstrap start time: $(date)" && \
    echo "ðŸ”§ Running actual bootstrap script for system parity..." && \
    ./bootstrap.sh && \
    echo "ðŸ¥ Health check after bootstrap:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" || echo 'âš ï¸  Empty system after bootstrap is expected' && \
    echo "ðŸ” Verifying tools installed by bootstrap scripts..." && \
    which stow && stow --version && \
    which just && just --version && \
    which python3 && python3 --version && \
    echo "âœ… Bootstrap complete!" && \
    echo "ðŸ• Bootstrap end time: $(date)"

FROM configure-mid-dev AS bootstrap-mid-dev
# Copy bootstrap files and health check tools
COPY --chown=user:user bootstrap.sh ./
COPY --chown=user:user bootstrap/ ./bootstrap/
COPY --chown=user:user tools/dotfiles-health/ ./tools/dotfiles-health/
RUN echo "=== BOOTSTRAP mid-dev STAGE ===" && \
    echo "ðŸ• Bootstrap start time: $(date)" && \
    echo "ðŸ”§ Running actual bootstrap script for system parity..." && \
    ./bootstrap.sh && \
    echo "ðŸ¥ Health check after bootstrap:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" || echo 'âš ï¸  Empty system after bootstrap is expected' && \
    echo "ðŸ” Verifying tools installed by bootstrap scripts..." && \
    which stow && stow --version && \
    which just && just --version && \
    which python3 && python3 --version && \
    echo "âœ… Bootstrap complete!" && \
    echo "ðŸ• Bootstrap end time: $(date)"

FROM configure-max-dev AS bootstrap-max-dev
# Copy bootstrap files and health check tools
COPY --chown=user:user bootstrap.sh ./
COPY --chown=user:user bootstrap/ ./bootstrap/
COPY --chown=user:user tools/dotfiles-health/ ./tools/dotfiles-health/
RUN echo "=== BOOTSTRAP max-dev STAGE ===" && \
    echo "ðŸ• Bootstrap start time: $(date)" && \
    echo "ðŸ”§ Running actual bootstrap script for system parity..." && \
    ./bootstrap.sh && \
    echo "ðŸ¥ Health check after bootstrap:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" || echo 'âš ï¸  Empty system after bootstrap is expected' && \
    echo "ðŸ” Verifying tools installed by bootstrap scripts..." && \
    which stow && stow --version && \
    which just && just --version && \
    which python3 && python3 --version && \
    echo "âœ… Bootstrap complete!" && \
    echo "ðŸ• Bootstrap end time: $(date)"

# =============================================================================
# STOW STAGE - Config deployment
# =============================================================================
FROM bootstrap-min-cli AS stow-min-cli
# Copy configuration files and package management scripts for stowing
COPY --chown=user:user configs/ ./configs/
COPY --chown=user:user justfile ./
COPY --chown=user:user tools/package-management/ ./tools/package-management/
RUN echo "=== STOW min-cli STAGE ===" && \
    echo "ðŸ” Showing configuration before stow:" && \
    cat ~/.dotfiles.env && \
    echo "ðŸ§¹ Removing default shell files that conflict with stow..." && \
    rm -f ~/.bash_profile ~/.bashrc && \
    just stow && \
    echo "ðŸ¥ Health check after stow:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" || echo 'âš ï¸  Health check after stow - some configs may not create visible symlinks' && \
    echo "âœ… Stow complete!"

FROM bootstrap-mid-cli AS stow-mid-cli
# Copy configuration files and package management scripts for stowing
COPY --chown=user:user configs/ ./configs/
COPY --chown=user:user justfile ./
COPY --chown=user:user tools/package-management/ ./tools/package-management/
RUN echo "=== STOW mid-cli STAGE ===" && \
    echo "ðŸ” Showing configuration before stow:" && \
    cat ~/.dotfiles.env && \
    echo "ðŸ§¹ Removing default shell files that conflict with stow..." && \
    rm -f ~/.bash_profile ~/.bashrc && \
    just stow && \
    echo "ðŸ¥ Health check after stow:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" || echo 'âš ï¸  Health check after stow - some configs may not create visible symlinks' && \
    echo "âœ… Stow complete!"

FROM bootstrap-mid-dev AS stow-mid-dev
# Copy configuration files and package management scripts for stowing
COPY --chown=user:user configs/ ./configs/
COPY --chown=user:user justfile ./
COPY --chown=user:user tools/package-management/ ./tools/package-management/
RUN echo "=== STOW mid-dev STAGE ===" && \
    echo "ðŸ” Showing configuration before stow:" && \
    cat ~/.dotfiles.env && \
    echo "ðŸ§¹ Removing default shell files that conflict with stow..." && \
    rm -f ~/.bash_profile ~/.bashrc && \
    just stow && \
    echo "ðŸ¥ Health check after stow:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" || echo 'âš ï¸  Health check after stow - some configs may not create visible symlinks' && \
    echo "âœ… Stow complete!"

FROM bootstrap-max-dev AS stow-max-dev
# Copy configuration files and package management scripts for stowing
COPY --chown=user:user configs/ ./configs/
COPY --chown=user:user justfile ./
COPY --chown=user:user tools/package-management/ ./tools/package-management/
RUN echo "=== STOW max-dev STAGE ===" && \
    echo "ðŸ” Showing configuration before stow:" && \
    cat ~/.dotfiles.env && \
    echo "ðŸ§¹ Removing default shell files that conflict with stow..." && \
    rm -f ~/.bash_profile ~/.bashrc && \
    just stow && \
    echo "ðŸ¥ Health check after stow:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" || echo 'âš ï¸  Health check after stow - some configs may not create visible symlinks' && \
    echo "âœ… Stow complete!"

# =============================================================================
# INSTALL STAGE - Package installation
# =============================================================================
FROM stow-min-cli AS install-min-cli
# Copy package management tools
COPY --chown=user:user tools/package-management/ ./tools/package-management/
RUN echo "=== INSTALL min-cli STAGE ===" && \
    echo "ðŸ“Š Showing configuration:" && \
    just show-config && \
    echo "ðŸ“¦ Installing packages..." && \
    just install && \
    echo "ðŸ¥ Health check after install:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" && \
    echo "âœ… Install complete!"

FROM stow-mid-cli AS install-mid-cli
# Copy package management tools
COPY --chown=user:user tools/package-management/ ./tools/package-management/
RUN echo "=== INSTALL mid-cli STAGE ===" && \
    echo "ðŸ“Š Showing configuration:" && \
    just show-config && \
    echo "ðŸ“¦ Installing packages..." && \
    just install && \
    echo "ðŸ¥ Health check after install:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" && \
    echo "âœ… Install complete!"

FROM stow-mid-dev AS install-mid-dev
# Copy package management tools
COPY --chown=user:user tools/package-management/ ./tools/package-management/
RUN echo "=== INSTALL mid-dev STAGE ===" && \
    echo "ðŸ“Š Showing configuration:" && \
    just show-config && \
    echo "ðŸ“¦ Installing packages..." && \
    just install && \
    echo "ðŸ¥ Health check after install:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" && \
    echo "âœ… Install complete!"

FROM stow-max-dev AS install-max-dev
# Copy package management tools
COPY --chown=user:user tools/package-management/ ./tools/package-management/
RUN echo "=== INSTALL max-dev STAGE ===" && \
    echo "ðŸ“Š Showing configuration:" && \
    just show-config && \
    echo "ðŸ“¦ Installing packages..." && \
    just install && \
    echo "ðŸ¥ Health check after install:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" && \
    echo "âœ… Install complete!"

# =============================================================================
# UPDATE STAGE - Complete workflow
# =============================================================================
FROM install-min-cli AS update-min-cli
RUN echo "=== UPDATE min-cli STAGE ===" && \
    just update-check && \
    echo "ðŸ¥ Final health check:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" && \
    echo "ðŸ§ª Verifying installed packages:" && \
    which git stow && \
    echo "âœ… Ubuntu min-cli workflow complete!"

FROM install-mid-cli AS update-mid-cli
RUN echo "=== UPDATE mid-cli STAGE ===" && \
    just update-check && \
    echo "ðŸ¥ Final health check:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" && \
    echo "ðŸ§ª Verifying installed packages:" && \
    which git stow && \
    echo "âœ… Ubuntu mid-cli workflow complete!"

FROM install-mid-dev AS update-mid-dev
RUN echo "=== UPDATE mid-dev STAGE ===" && \
    just update-check && \
    echo "ðŸ¥ Final health check:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" && \
    echo "ðŸ§ª Verifying installed packages:" && \
    which git stow && \
    echo "âœ… Ubuntu mid-dev workflow complete!"

FROM install-max-dev AS update-max-dev
RUN echo "=== UPDATE max-dev STAGE ===" && \
    just update-check && \
    echo "ðŸ¥ Final health check:" && \
    bash -c "set -a && source ~/.dotfiles.env 2>/dev/null && set +a && bash tools/dotfiles-health/dotfiles-health.sh" && \
    echo "ðŸ§ª Verifying installed packages:" && \
    which git stow && \
    echo "âœ… Ubuntu max-dev workflow complete!"

# Legacy compatibility targets
FROM update-min-cli AS update-basic