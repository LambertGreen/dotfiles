# Multi-stage Dockerfile for Ubuntu dotfiles - Modular Architecture
# Docker as a valid Linux runtime on non-Linux machines

# =============================================================================
# SHARED BASE STAGE - Common system setup for all Ubuntu containers
# =============================================================================
FROM ubuntu:22.04 AS ubuntu-base

# Install only minimal system requirements, then use real bootstrap scripts
RUN apt-get update --quiet && \
    DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
      sudo git openssh-client wget curl ca-certificates build-essential \
      bash zsh locales && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    useradd -u 1000 --create-home --comment "Ubuntu dotfiles user" user && \
    usermod -aG sudo user && \
    echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
    echo 'user:user' | chpasswd && \
    # Configure locale to avoid perl warnings
    locale-gen en_US.UTF-8 && \
    update-locale LANG=en_US.UTF-8

USER user
WORKDIR /home/user

# Set locale environment variables
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV LANGUAGE=en_US:en

# Set timezone from host system (fallback to UTC)
ARG TZ
ENV TZ=${TZ:-UTC}
RUN sudo ln -sf /usr/share/zoneinfo/$TZ /etc/localtime

WORKDIR /home/user/dotfiles

# =============================================================================
# SHARED CONFIGURE STAGE - Configuration with efficient caching
# =============================================================================
FROM ubuntu-base AS ubuntu-configure
ARG MACHINE_CLASS
ENV DOTFILES_MACHINE_CLASS=${MACHINE_CLASS}

# Copy only configuration script for better caching
COPY --chown=user:user configure.sh ./
COPY --chown=user:user scripts/package-management/interactive-prompts.sh scripts/package-management/
# Copy all machine classes (configure script needs to validate the choice)
COPY --chown=user:user machine-classes/ ./machine-classes/

# Set fast timeout for Docker and pre-select machine class
ENV DOTFILES_PROMPT_TIMEOUT=3

# Configure - real user command with fast timeout
RUN ./configure.sh

# =============================================================================
# SHARED BOOTSTRAP STAGE - Install core tools
# =============================================================================
FROM ubuntu-configure AS ubuntu-bootstrap

# Copy only bootstrap files for caching
COPY --chown=user:user bootstrap.sh ./
COPY --chown=user:user scripts/bootstrap/ ./scripts/bootstrap/

# Bootstrap - real user command  
RUN ./bootstrap.sh

# =============================================================================
# SHARED STOW STAGE - Deploy configurations
# =============================================================================
FROM ubuntu-bootstrap AS ubuntu-stow

# Copy configuration files for stowing
COPY --chown=user:user configs/ ./configs/
COPY --chown=user:user justfile ./
COPY --chown=user:user scripts/health/ ./scripts/health/
COPY --chown=user:user scripts/stow/ ./scripts/stow/

# Remove default shell files that conflict with stow
RUN rm -f /home/user/.bashrc /home/user/.bash_profile /home/user/.profile || true
# Deploy configurations - real user command
RUN just stow

# =============================================================================
# SHARED SHELL SETUP STAGE - Initialize zsh environment with zinit
# =============================================================================
FROM ubuntu-stow AS ubuntu-shell

# Switch to zsh login shell and let it auto-install zinit and plugins naturally
# Stage 1: Install zinit (first zsh startup)
RUN echo 'exit' | zsh -l -i
# Stage 2: Install all plugins including async ones (second zsh startup with forced download)
RUN echo 'zinit update --all && zinit cclear && echo "All plugins installed and compiled" && exit' | zsh -l -i

# =============================================================================
# SHARED INSTALL STAGE - Package installation
# =============================================================================
FROM ubuntu-shell AS ubuntu-install

# Copy package management system
COPY --chown=user:user scripts/package-management/ ./scripts/package-management/
# Create expected directory structure for scripts
RUN mkdir -p ./machine-classes/scripts/
RUN cp ./scripts/package-management/interactive-prompts.sh ./machine-classes/scripts/

# Install packages using configured shell environment
RUN zsh -l -c 'just install-packages'

# =============================================================================
# MACHINE-SPECIFIC FINAL STAGES
# =============================================================================

# Essential Ubuntu - Minimal system with apt + homebrew for emacs 30+
FROM ubuntu-install AS docker_essential_ubuntu
ARG MACHINE_CLASS=docker_essential_ubuntu
ENV DOTFILES_MACHINE_CLASS=${MACHINE_CLASS}
RUN zsh -l -c 'just check-health && just show-package-stats'

# Developer Ubuntu - Development environment with apt + homebrew + pip + npm  
FROM ubuntu-install AS docker_developer_ubuntu
ARG MACHINE_CLASS=docker_developer_ubuntu
ENV DOTFILES_MACHINE_CLASS=${MACHINE_CLASS}
RUN zsh -l -c 'just check-health && just show-package-stats'

# GUI Ubuntu - Full desktop environment (validation only)
FROM ubuntu-install AS docker_ubuntu_gui
ARG MACHINE_CLASS=docker_ubuntu_gui
ENV DOTFILES_MACHINE_CLASS=${MACHINE_CLASS}
RUN zsh -l -c 'just check-health && just show-package-stats'