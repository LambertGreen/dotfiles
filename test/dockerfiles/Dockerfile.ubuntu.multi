# Multi-stage Dockerfile for Ubuntu dotfiles
# Docker as a valid Linux runtime on non-Linux machines

# =============================================================================
# BASE STAGE - Common system setup for all Ubuntu containers
# =============================================================================
FROM ubuntu:22.04 AS base

# Install only minimal system requirements, then use real bootstrap scripts
RUN apt-get update --quiet && \
    DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
      sudo git openssh-client wget curl ca-certificates build-essential \
      bash zsh && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    useradd -u 1000 --create-home --comment "Ubuntu dotfiles user" user && \
    usermod -aG sudo user && \
    echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
    echo 'user:user' | chpasswd

USER user
WORKDIR /home/user

# Set timezone from host system (fallback to UTC)
ARG TZ
ENV TZ=${TZ:-UTC}
RUN sudo ln -sf /usr/share/zoneinfo/$TZ /etc/localtime

WORKDIR /home/user/dotfiles

# =============================================================================
# CONFIGURE STAGE - Configuration with efficient caching
# =============================================================================
FROM base AS configure-ubuntu-essential

# Copy only configuration script for better caching
COPY --chown=user:user configure.sh ./
COPY --chown=user:user scripts/package-management/interactive-prompts.sh scripts/package-management/
# Copy only package manager configs needed for configure (not stow configs)
COPY --chown=user:user package-management/machines/docker_ubuntu_essential/apt/ ./package-management/machines/docker_ubuntu_essential/apt/
COPY --chown=user:user package-management/machines/docker_ubuntu_essential/brew/ ./package-management/machines/docker_ubuntu_essential/brew/

# Set fast timeout for Docker and pre-select machine class
ENV DOTFILES_PROMPT_TIMEOUT=3
ENV DOTFILES_MACHINE_CLASS=docker_ubuntu_essential

# Configure - real user command with fast timeout
RUN ./configure.sh

# =============================================================================
# BOOTSTRAP STAGE - Install core tools
# =============================================================================
FROM configure-ubuntu-essential AS bootstrap-ubuntu-essential

# Copy only bootstrap files for caching
COPY --chown=user:user bootstrap.sh ./
COPY --chown=user:user scripts/bootstrap/ ./scripts/bootstrap/

# Bootstrap - real user command  
RUN ./bootstrap.sh

# =============================================================================
# STOW STAGE - Deploy configurations
# =============================================================================
FROM bootstrap-ubuntu-essential AS stow-ubuntu-essential

# Copy configuration files for stowing
COPY --chown=user:user configs/ ./configs/
COPY --chown=user:user justfile ./
COPY --chown=user:user scripts/health/ ./scripts/health/
COPY --chown=user:user scripts/stow/ ./scripts/stow/
# Copy stow configuration for this machine class
COPY --chown=user:user package-management/machines/docker_ubuntu_essential/stow/ ./package-management/machines/docker_ubuntu_essential/stow/

# Remove default shell files that conflict with stow
RUN rm -f /home/user/.bashrc /home/user/.bash_profile /home/user/.profile || true
# Deploy configurations - real user command
RUN just stow

# =============================================================================
# INSTALL STAGE - Package installation
# =============================================================================
FROM stow-ubuntu-essential AS install-ubuntu-essential

# Copy only package management files needed for install stage
COPY --chown=user:user package-management/machines/docker_ubuntu_essential/apt/ ./package-management/machines/docker_ubuntu_essential/apt/
COPY --chown=user:user package-management/machines/docker_ubuntu_essential/brew/ ./package-management/machines/docker_ubuntu_essential/brew/
COPY --chown=user:user scripts/package-management/ ./scripts/package-management/
# Create expected directory structure for scripts
RUN mkdir -p ./package-management/scripts/
RUN cp ./scripts/package-management/interactive-prompts.sh ./package-management/scripts/

# Install packages - real user command
RUN just install-packages

# =============================================================================
# FINAL STAGE: docker_ubuntu_essential
# Minimal Ubuntu system with apt + homebrew for emacs 30+
# =============================================================================
FROM install-ubuntu-essential AS docker_ubuntu_essential

# Final validation - real user commands
RUN just check-health && \
    just show-package-stats

# =============================================================================
# MACHINE CLASS: docker_ubuntu_developer
# Development environment with apt + homebrew + pip + npm
# =============================================================================
# Configure stage for developer
FROM base AS configure-ubuntu-developer

# Copy only configuration script and machine definitions for better caching
COPY --chown=user:user configure.sh ./
COPY --chown=user:user scripts/package-management/interactive-prompts.sh scripts/package-management/
COPY --chown=user:user package-management/machines/ ./package-management/machines/

# Set fast timeout for Docker and pre-select machine class
ENV DOTFILES_PROMPT_TIMEOUT=3
ENV DOTFILES_MACHINE_CLASS=docker_ubuntu_developer

# Configure - real user command with fast timeout
RUN ./configure.sh

# Bootstrap stage for developer
FROM configure-ubuntu-developer AS bootstrap-ubuntu-developer

# Copy only bootstrap files for caching
COPY --chown=user:user bootstrap.sh ./
COPY --chown=user:user scripts/bootstrap/ ./scripts/bootstrap/

# Bootstrap - real user command  
RUN ./bootstrap.sh

# Stow stage for developer
FROM bootstrap-ubuntu-developer AS stow-ubuntu-developer

# Copy configuration files for stowing
COPY --chown=user:user configs/ ./configs/
COPY --chown=user:user justfile ./
COPY --chown=user:user scripts/health/ ./scripts/health/
COPY --chown=user:user scripts/stow/ ./scripts/stow/

# Remove default shell files that conflict with stow
RUN rm -f /home/user/.bashrc /home/user/.bash_profile /home/user/.profile || true
# Deploy configurations - real user command
RUN just stow

# Install stage for developer
FROM stow-ubuntu-developer AS install-ubuntu-developer

# Copy package management system
COPY --chown=user:user package-management/ ./package-management/
COPY --chown=user:user scripts/package-management/ ./scripts/package-management/
# Create expected directory structure for scripts
RUN mkdir -p ./package-management/scripts/
RUN cp ./scripts/package-management/interactive-prompts.sh ./package-management/scripts/

# Install packages - real user command
RUN just install-packages

# Final stage for developer
FROM install-ubuntu-developer AS docker_ubuntu_developer

# Final validation - real user commands
RUN just check-health && \
    just show-package-stats

# =============================================================================
# MACHINE CLASS: docker_ubuntu_gui
# Full desktop environment (validation only)
# =============================================================================
# Configure stage for GUI
FROM base AS configure-ubuntu-gui

# Copy only configuration script and machine definitions for better caching
COPY --chown=user:user configure.sh ./
COPY --chown=user:user scripts/package-management/interactive-prompts.sh scripts/package-management/
COPY --chown=user:user package-management/machines/ ./package-management/machines/

# Set fast timeout for Docker and pre-select machine class
ENV DOTFILES_PROMPT_TIMEOUT=3
ENV DOTFILES_MACHINE_CLASS=docker_ubuntu_gui

# Configure - real user command with fast timeout
RUN ./configure.sh

# Bootstrap stage for GUI
FROM configure-ubuntu-gui AS bootstrap-ubuntu-gui

# Copy only bootstrap files for caching
COPY --chown=user:user bootstrap.sh ./
COPY --chown=user:user scripts/bootstrap/ ./scripts/bootstrap/

# Bootstrap - real user command  
RUN ./bootstrap.sh

# Stow stage for GUI
FROM bootstrap-ubuntu-gui AS stow-ubuntu-gui

# Copy configuration files for stowing
COPY --chown=user:user configs/ ./configs/
COPY --chown=user:user justfile ./
COPY --chown=user:user scripts/health/ ./scripts/health/
COPY --chown=user:user scripts/stow/ ./scripts/stow/

# Remove default shell files that conflict with stow
RUN rm -f /home/user/.bashrc /home/user/.bash_profile /home/user/.profile || true
# Deploy configurations - real user command
RUN just stow

# Install stage for GUI
FROM stow-ubuntu-gui AS install-ubuntu-gui

# Copy package management system
COPY --chown=user:user package-management/ ./package-management/
COPY --chown=user:user scripts/package-management/ ./scripts/package-management/
# Create expected directory structure for scripts
RUN mkdir -p ./package-management/scripts/
RUN cp ./scripts/package-management/interactive-prompts.sh ./package-management/scripts/

# Install packages - real user command
RUN just install-packages

# Final stage for GUI
FROM install-ubuntu-gui AS docker_ubuntu_gui

# Final validation - real user commands
RUN just check-health && \
    just show-package-stats