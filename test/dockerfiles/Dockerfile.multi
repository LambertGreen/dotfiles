# Multi-platform Dockerfile for dotfiles - Truly Shared Architecture
# Single Dockerfile supporting Ubuntu and Arch with shared stages
# Usage:
#   docker build --build-arg MACHINE_CLASS=docker_essential_ubuntu --target docker_essential_ubuntu
#   docker build --build-arg MACHINE_CLASS=docker_essential_arch --target docker_essential_arch

# =============================================================================
# PLATFORM-SPECIFIC BASE IMAGES
# =============================================================================

FROM ubuntu:22.04 AS base-ubuntu
# Install minimal system requirements for Ubuntu
RUN apt-get update --quiet && \
    DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
      sudo git openssh-client wget curl ca-certificates build-essential \
      bash zsh locales less && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    useradd -u 1000 --create-home --comment "Ubuntu dotfiles user" user && \
    usermod -aG sudo user && \
    echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
    echo 'user:user' | chpasswd && \
    locale-gen en_US.UTF-8 && \
    update-locale LANG=en_US.UTF-8

FROM --platform=linux/amd64 archlinux:latest AS base-arch
# Install minimal system requirements for Arch
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm git curl wget sudo base-devel tzdata zsh less && \
    useradd -m -G wheel -s /bin/bash user && \
    echo 'user ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers && \
    echo 'en_US.UTF-8 UTF-8' >> /etc/locale.gen && \
    locale-gen

# =============================================================================
# SHARED SETUP TEMPLATE - Common logic for both platforms
# =============================================================================

# Ubuntu setup path
FROM base-ubuntu AS setup-ubuntu
USER user
WORKDIR /home/user
ENV LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8 LANGUAGE=en_US:en
ENV TERM=xterm-256color
ARG TZ
ENV TZ=${TZ:-UTC}
RUN sudo ln -sf /usr/share/zoneinfo/$TZ /etc/localtime
WORKDIR /home/user/dotfiles

# Arch setup path
FROM base-arch AS setup-arch
USER user
WORKDIR /home/user
ENV LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8 LANGUAGE=en_US:en
ENV TERM=xterm-256color
ARG TZ
ENV TZ=${TZ:-UTC}
RUN sudo ln -sf /usr/share/zoneinfo/$TZ /etc/localtime
WORKDIR /home/user/dotfiles

# =============================================================================
# UBUNTU BUILD PATH - Uses ubuntu platform detection
# =============================================================================

FROM setup-ubuntu AS configure-ubuntu
ARG MACHINE_CLASS
ENV DOTFILES_MACHINE_CLASS=${MACHINE_CLASS}
ENV DOTFILES_PLATFORM=ubuntu

COPY --chown=user:user configure.sh ./
COPY --chown=user:user scripts/package-management/interactive-prompts.sh scripts/package-management/
COPY --chown=user:user machine-classes/ ./machine-classes/

ENV DOTFILES_PROMPT_TIMEOUT=3
RUN ./configure.sh

FROM configure-ubuntu AS bootstrap-ubuntu
COPY --chown=user:user bootstrap.sh ./
COPY --chown=user:user scripts/bootstrap/ ./scripts/bootstrap/
RUN ./bootstrap.sh

FROM bootstrap-ubuntu AS stow-ubuntu
COPY --chown=user:user configs/ ./configs/
COPY --chown=user:user justfile ./
COPY --chown=user:user scripts/health/ ./scripts/health/
COPY --chown=user:user scripts/stow/ ./scripts/stow/
COPY --chown=user:user scripts/show-config.sh ./scripts/
RUN just stow

FROM stow-ubuntu AS shell-ubuntu
# Use dotfiles API to initialize shell plugins
COPY --chown=user:user scripts/package-management/init-dev-packages.sh ./scripts/package-management/
COPY --chown=user:user scripts/package-management/verify-dev-package-install.sh ./scripts/package-management/
RUN ./scripts/package-management/init-dev-packages.sh || true

FROM shell-ubuntu AS install-ubuntu
# Copy shared package management utilities first (changes least frequently)
COPY --chown=user:user scripts/package-management/shared/ ./scripts/package-management/shared/
COPY --chown=user:user scripts/package-management/interactive-prompts.sh ./scripts/package-management/

# =============================================================================
# SYSTEM PACKAGE INSTALLATION STAGE
# Uses new orchestration scripts for proper dependency ordering
# =============================================================================

FROM install-ubuntu AS system-packages-ubuntu
# Copy orchestration scripts
COPY --chown=user:user scripts/package-management/install-system-packages.sh ./scripts/package-management/
# Copy all system package manager scripts
COPY --chown=user:user scripts/package-management/apt/ ./scripts/package-management/apt/
COPY --chown=user:user scripts/package-management/brew/ ./scripts/package-management/brew/
COPY --chown=user:user justfile ./
# Install system packages (admin then user)
RUN just install-system-packages || true

# =============================================================================
# DEV PACKAGE INSTALLATION STAGE
# Language package managers (npm, pip, cargo, gem)
# =============================================================================

FROM system-packages-ubuntu AS dev-packages-ubuntu
# Copy dev orchestration script
COPY --chown=user:user scripts/package-management/install-dev-packages.sh ./scripts/package-management/
# Copy all dev package manager scripts
COPY --chown=user:user scripts/package-management/pip/ ./scripts/package-management/pip/
COPY --chown=user:user scripts/package-management/npm/ ./scripts/package-management/npm/
COPY --chown=user:user scripts/package-management/gem/ ./scripts/package-management/gem/
COPY --chown=user:user scripts/package-management/cargo/ ./scripts/package-management/cargo/
# Install dev packages
RUN just install-dev-packages || true

# =============================================================================
# APP PACKAGE INSTALLATION STAGE
# Application package managers (zinit, elpaca, lazy.nvim)
# =============================================================================

FROM dev-packages-ubuntu AS app-packages-ubuntu
# Copy app orchestration script
COPY --chown=user:user scripts/package-management/install-app-packages.sh ./scripts/package-management/
# Copy all app package manager scripts
COPY --chown=user:user scripts/package-management/emacs/ ./scripts/package-management/emacs/
COPY --chown=user:user scripts/package-management/neovim/ ./scripts/package-management/neovim/
COPY --chown=user:user scripts/package-management/zsh/ ./scripts/package-management/zsh/
# Install app packages
RUN just install-app-packages || true

# =============================================================================
# ARCH BUILD PATH - Uses arch platform detection
# =============================================================================

FROM setup-arch AS configure-arch
ARG MACHINE_CLASS
ENV DOTFILES_MACHINE_CLASS=${MACHINE_CLASS}
ENV DOTFILES_PLATFORM=arch

COPY --chown=user:user configure.sh ./
COPY --chown=user:user scripts/package-management/interactive-prompts.sh scripts/package-management/
COPY --chown=user:user machine-classes/ ./machine-classes/

ENV DOTFILES_PROMPT_TIMEOUT=3
RUN ./configure.sh

FROM configure-arch AS bootstrap-arch
COPY --chown=user:user bootstrap.sh ./
COPY --chown=user:user scripts/bootstrap/ ./scripts/bootstrap/
RUN ./bootstrap.sh

FROM bootstrap-arch AS stow-arch
COPY --chown=user:user configs/ ./configs/
COPY --chown=user:user justfile ./
COPY --chown=user:user scripts/health/ ./scripts/health/
COPY --chown=user:user scripts/stow/ ./scripts/stow/
COPY --chown=user:user scripts/show-config.sh ./scripts/
RUN just stow

FROM stow-arch AS shell-arch
# Use dotfiles API to initialize shell plugins
COPY --chown=user:user scripts/package-management/init-dev-packages.sh ./scripts/package-management/
COPY --chown=user:user scripts/package-management/verify-dev-package-install.sh ./scripts/package-management/
RUN ./scripts/package-management/init-dev-packages.sh || true

FROM shell-arch AS install-arch
# Copy shared package management utilities first (changes least frequently)
COPY --chown=user:user scripts/package-management/shared/ ./scripts/package-management/shared/
COPY --chown=user:user scripts/package-management/interactive-prompts.sh ./scripts/package-management/

# =============================================================================
# SYSTEM PACKAGE INSTALLATION STAGE
# Uses new orchestration scripts for proper dependency ordering
# =============================================================================

FROM install-arch AS system-packages-arch
# Copy orchestration scripts
COPY --chown=user:user scripts/package-management/install-system-packages.sh ./scripts/package-management/
# Copy all system package manager scripts
COPY --chown=user:user scripts/package-management/pacman/ ./scripts/package-management/pacman/
COPY --chown=user:user scripts/package-management/brew/ ./scripts/package-management/brew/
COPY --chown=user:user justfile ./
# Install system packages (admin then user)
RUN just install-system-packages || true

# =============================================================================
# DEV PACKAGE INSTALLATION STAGE
# Language package managers (npm, pip, cargo, gem)
# =============================================================================

FROM system-packages-arch AS dev-packages-arch
# Copy dev orchestration script
COPY --chown=user:user scripts/package-management/install-dev-packages.sh ./scripts/package-management/
# Copy all dev package manager scripts
COPY --chown=user:user scripts/package-management/pip/ ./scripts/package-management/pip/
COPY --chown=user:user scripts/package-management/npm/ ./scripts/package-management/npm/
COPY --chown=user:user scripts/package-management/gem/ ./scripts/package-management/gem/
COPY --chown=user:user scripts/package-management/cargo/ ./scripts/package-management/cargo/
# Install dev packages
RUN just install-dev-packages || true

# =============================================================================
# APP PACKAGE INSTALLATION STAGE
# Application package managers (zinit, elpaca, lazy.nvim)
# =============================================================================

FROM dev-packages-arch AS app-packages-arch
# Copy app orchestration script
COPY --chown=user:user scripts/package-management/install-app-packages.sh ./scripts/package-management/
# Copy all app package manager scripts
COPY --chown=user:user scripts/package-management/emacs/ ./scripts/package-management/emacs/
COPY --chown=user:user scripts/package-management/neovim/ ./scripts/package-management/neovim/
COPY --chown=user:user scripts/package-management/zsh/ ./scripts/package-management/zsh/
# Install app packages
RUN just install-app-packages || true

# =============================================================================
# FINAL MACHINE-SPECIFIC TARGETS
# =============================================================================

# Ubuntu machine classes
FROM app-packages-ubuntu AS docker_essential_ubuntu
ARG MACHINE_CLASS=docker_essential_ubuntu
ENV DOTFILES_MACHINE_CLASS=${MACHINE_CLASS}
# Copy all remaining package management scripts for final stage
COPY --chown=user:user scripts/package-management/*.sh ./scripts/package-management/
RUN chmod +x ./scripts/package-management/*.sh
# Copy machine class definitions last (touching these invalidates check/upgrade testing)
COPY --chown=user:user machine-classes/ ./machine-classes/
# Test package checking and health
RUN zsh -l -c 'just check-health && just check-packages && just show-package-stats'

FROM app-packages-ubuntu AS docker_developer_ubuntu
ARG MACHINE_CLASS=docker_developer_ubuntu
ENV DOTFILES_MACHINE_CLASS=${MACHINE_CLASS}
# Copy all remaining package management scripts for final stage
COPY --chown=user:user scripts/package-management/*.sh ./scripts/package-management/
RUN chmod +x ./scripts/package-management/*.sh
# Copy machine class definitions last (touching these invalidates check/upgrade testing)
COPY --chown=user:user machine-classes/ ./machine-classes/
# Test package checking and health
RUN zsh -l -c 'just check-health && just check-packages && just show-package-stats'

FROM app-packages-ubuntu AS docker_ubuntu_gui
ARG MACHINE_CLASS=docker_ubuntu_gui
ENV DOTFILES_MACHINE_CLASS=${MACHINE_CLASS}
# Copy all remaining package management scripts for final stage
COPY --chown=user:user scripts/package-management/*.sh ./scripts/package-management/
RUN chmod +x ./scripts/package-management/*.sh
# Copy machine class definitions last (touching these invalidates check/upgrade testing)
COPY --chown=user:user machine-classes/ ./machine-classes/
# Test package checking and health
RUN zsh -l -c 'just check-health && just check-packages && just show-package-stats'

# Arch machine classes
FROM app-packages-arch AS docker_essential_arch
ARG MACHINE_CLASS=docker_essential_arch
ENV DOTFILES_MACHINE_CLASS=${MACHINE_CLASS}
# Copy all remaining package management scripts for final stage
COPY --chown=user:user scripts/package-management/*.sh ./scripts/package-management/
RUN chmod +x ./scripts/package-management/*.sh
# Copy machine class definitions last (touching these invalidates check/upgrade testing)
COPY --chown=user:user machine-classes/ ./machine-classes/
# Test package checking and health
RUN zsh -l -c 'just check-health && just check-packages && just show-package-stats'

FROM app-packages-arch AS docker_developer_arch
ARG MACHINE_CLASS=docker_developer_arch
ENV DOTFILES_MACHINE_CLASS=${MACHINE_CLASS}
# Copy all remaining package management scripts for final stage
COPY --chown=user:user scripts/package-management/*.sh ./scripts/package-management/
RUN chmod +x ./scripts/package-management/*.sh
# Copy machine class definitions last (touching these invalidates check/upgrade testing)
COPY --chown=user:user machine-classes/ ./machine-classes/
# Test package checking and health
RUN zsh -l -c 'just check-health && just check-packages && just show-package-stats'

FROM app-packages-arch AS docker_arch_gui
ARG MACHINE_CLASS=docker_arch_gui
ENV DOTFILES_MACHINE_CLASS=${MACHINE_CLASS}
# Copy all remaining package management scripts for final stage
COPY --chown=user:user scripts/package-management/*.sh ./scripts/package-management/
RUN chmod +x ./scripts/package-management/*.sh
# Copy machine class definitions last (touching these invalidates check/upgrade testing)
COPY --chown=user:user machine-classes/ ./machine-classes/
# Test package checking and health
RUN zsh -l -c 'just check-health && just check-packages && just show-package-stats'

# =============================================================================
# MAINTENANCE WORKFLOW TEST STAGES
# Tests check+upgrade cycle using cached registry state
# Triggered by touching local files to break Docker cache
# =============================================================================

# Ubuntu maintenance workflows
FROM docker_essential_ubuntu AS maintenance-ubuntu
# Copy check/upgrade scripts (changes to these files will break cache here)
COPY --chown=user:user scripts/package-management/check-system-packages.sh ./scripts/package-management/
COPY --chown=user:user scripts/package-management/upgrade-system-packages.sh ./scripts/package-management/
COPY --chown=user:user scripts/package-management/check-dev-packages.sh ./scripts/package-management/
COPY --chown=user:user scripts/package-management/upgrade-dev-packages.sh ./scripts/package-management/
# Test maintenance workflow: check then upgrade (using cached registries)
RUN zsh -l -c 'just check-system-packages && just upgrade-system-packages' || true
RUN zsh -l -c 'just check-dev-packages && just upgrade-dev-packages' || true
RUN zsh -l -c 'just check-health && just show-package-stats'

FROM docker_developer_ubuntu AS maintenance-dev-ubuntu
# Copy check/upgrade scripts (changes to these files will break cache here)
COPY --chown=user:user scripts/package-management/check-system-packages.sh ./scripts/package-management/
COPY --chown=user:user scripts/package-management/upgrade-system-packages.sh ./scripts/package-management/
COPY --chown=user:user scripts/package-management/check-dev-packages.sh ./scripts/package-management/
COPY --chown=user:user scripts/package-management/upgrade-dev-packages.sh ./scripts/package-management/
# Test maintenance workflow: check then upgrade (using cached registries)
RUN zsh -l -c 'just check-system-packages && just upgrade-system-packages' || true
RUN zsh -l -c 'just check-dev-packages && just upgrade-dev-packages' || true
RUN zsh -l -c 'just check-health && just show-package-stats'

# Arch maintenance workflows
FROM docker_essential_arch AS maintenance-arch
# Copy check/upgrade scripts (changes to these files will break cache here)
COPY --chown=user:user scripts/package-management/check-system-packages.sh ./scripts/package-management/
COPY --chown=user:user scripts/package-management/upgrade-system-packages.sh ./scripts/package-management/
COPY --chown=user:user scripts/package-management/check-dev-packages.sh ./scripts/package-management/
COPY --chown=user:user scripts/package-management/upgrade-dev-packages.sh ./scripts/package-management/
# Test maintenance workflow: check then upgrade (using cached registries)
RUN zsh -l -c 'just check-system-packages && just upgrade-system-packages' || true
RUN zsh -l -c 'just check-dev-packages && just upgrade-dev-packages' || true
RUN zsh -l -c 'just check-health && just show-package-stats'

FROM docker_developer_arch AS maintenance-dev-arch
# Copy check/upgrade scripts (changes to these files will break cache here)
COPY --chown=user:user scripts/package-management/check-system-packages.sh ./scripts/package-management/
COPY --chown=user:user scripts/package-management/upgrade-system-packages.sh ./scripts/package-management/
COPY --chown=user:user scripts/package-management/check-dev-packages.sh ./scripts/package-management/
COPY --chown=user:user scripts/package-management/upgrade-dev-packages.sh ./scripts/package-management/
# Test maintenance workflow: check then upgrade (using cached registries)
RUN zsh -l -c 'just check-system-packages && just upgrade-system-packages' || true
RUN zsh -l -c 'just check-dev-packages && just upgrade-dev-packages' || true
RUN zsh -l -c 'just check-health && just show-package-stats'
