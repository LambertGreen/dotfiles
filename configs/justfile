#!/usr/bin/env just
# -*- mode: just -*-

# Configuration-aware dotfiles stowing using new directory structure
# Uses ~/.dotfiles.env to determine which configs to stow

_default:
    @echo "ğŸ”— Configuration-Aware Stowing"
    @echo ""
    @just --list

# =============================================================================
# PLATFORM-AWARE STOWING
# =============================================================================

# ğŸ›ï¸ Arch Linux stowing
arch *args:
    @echo "ğŸ›ï¸ Arch Linux stowing..."
    @just _stow-platform "arch" "{{ args }}"

# ğŸ§ Ubuntu Linux stowing
ubuntu *args:
    @echo "ğŸ§ Ubuntu Linux stowing..."
    @just _stow-platform "ubuntu" "{{ args }}"

# ğŸ macOS stowing
osx *args:
    @echo "ğŸ macOS stowing..."
    @just _stow-platform "osx" "{{ args }}"

# ğŸªŸ Windows stowing
win *args:
    @echo "ğŸªŸ Windows stowing..."
    @just _stow-platform "win" "{{ args }}"

# =============================================================================
# INTERNAL HELPERS
# =============================================================================

# Internal helper for platform-specific stowing
[private]
_stow-platform platform args:
    @if [ "{{ args }}" = "stow-basic" ]; then \
        echo "ğŸ”— Stowing basic {{ platform }} configs using new structure..."; \
        just _stow-configs "{{ platform }}"; \
    else \
        echo "âŒ Only 'stow-basic' is supported with new structure"; \
        echo "ğŸ’¡ Use main 'just stow' command for configuration-aware stowing"; \
        exit 1; \
    fi

# Internal helper to stow configs based on platform
[private]
_stow-configs platform:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "ğŸ”— Stowing common configs..."
    cd common && stow *
    
    case "{{ platform }}" in
        "osx")
            echo "ğŸ”— Stowing macOS-specific configs..."
            cd ../osx_only && stow *
            ;;
        "ubuntu"|"arch")
            echo "ğŸ”— Stowing Linux-specific configs..."
            cd ../linux_only && stow *
            ;;
        "win")
            echo "ğŸ”— Stowing Windows-specific configs..."
            cd ../windows_only && stow *
            ;;
        *)
            echo "âŒ Unknown platform: {{ platform }}"
            exit 1
            ;;
    esac
    
    echo "âœ… Stowing complete for {{ platform }}"