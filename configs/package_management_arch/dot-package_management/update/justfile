#!/usr/bin/env just
# -*- mode: just -*-

# Maintenance tasks for Arch Linux
# Regular package updates and system maintenance

import 'justfile_dev_common'

default:
    @just --list

# ðŸ“¦ Update all official packages
update-pacman:
    sudo pacman -Syu --noconfirm

# ðŸ“¦ Update AUR packages (if yay is installed)
update-aur:
    @if command -v yay >/dev/null 2>&1; then \
        yay -Sua --noconfirm; \
    else \
        echo "yay not installed - skipping AUR updates"; \
    fi

# ðŸ“¦ Update all packages (official + AUR)
update-all: update-pacman update-aur

# ðŸ§¹ Clean package cache
clean-cache:
    sudo pacman -Sc --noconfirm
    @if command -v yay >/dev/null 2>&1; then \
        yay -Sc --noconfirm; \
    fi

# ðŸ—‘ï¸ Remove orphaned packages
remove-orphans:
    @echo "Removing orphaned packages..."
    @orphans=$$(pacman -Qtdq); \
    if [ -n "$$orphans" ]; then \
        sudo pacman -Rns $$orphans --noconfirm; \
        echo "Removed orphaned packages: $$orphans"; \
    else \
        echo "No orphaned packages found"; \
    fi

# ðŸ” List explicitly installed packages
list-explicit:
    pacman -Qe

# ðŸ” Show package statistics
show-stats:
    @echo "Package statistics:"
    @echo "Total packages: $$(pacman -Q | wc -l)"
    @echo "Explicitly installed: $$(pacman -Qe | wc -l)"
    @echo "Dependencies: $$(pacman -Qd | wc -l)"
    @if command -v yay >/dev/null 2>&1; then \
        echo "AUR packages: $$(pacman -Qm | wc -l)"; \
    fi

# ðŸ”§ Full maintenance (update + clean + remove orphans)
full-maintenance: update-all clean-cache remove-orphans
    @echo "âœ… Full Arch maintenance complete!"

# =============================================================================
# LEVEL-BASED UPDATE RECIPES (matches bootstrap levels - which package managers are available)
# =============================================================================

# Basic level - system package manager only (matches bootstrap-basic)
update-basic: update-pacman
    @echo "âœ… Basic Arch updates complete (system packages only)!"

# Typical level - system + AUR helper (matches bootstrap-typical)
update-typical: update-pacman update-aur
    @echo "âœ… Typical Arch updates complete (system + AUR packages)!"

# Max level - all package managers including Nix (matches bootstrap-max)
update-max: update-pacman update-aur
    @echo "ðŸ”„ Updating Nix packages..."
    @if command -v nix >/dev/null 2>&1; then \
        nix-channel --update && nix-env -u; \
        echo "âœ… Max Arch updates complete (system + AUR + Nix)!"; \
    else \
        echo "âœ… Max Arch updates complete (system + AUR, Nix not installed)!"; \
    fi
