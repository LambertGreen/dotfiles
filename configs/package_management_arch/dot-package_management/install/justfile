#!/usr/bin/env just
# -*- mode: just -*-

# Package installation for Arch Linux
# Run once during initial machine setup
# Uses pacman (official) + AUR helper + pip/npm/gem for dev tools

import 'justfile_dev_common'

default:
    @just --list

# 📦 Update system packages (always run first)
update-system:
    sudo pacman -Syu --noconfirm

# 🔧 Install essential system packages (Priority 1 - Core)
install-system-core: update-system
    sudo pacman -S --noconfirm \
        base-devel \
        curl \
        wget \
        git \
        stow \
        zsh \
        tmux \
        python \
        python-pip \
        nodejs \
        npm \
        ruby \
        rust \
        cargo \
        rust-analyzer \
        openssh \
        gnupg
    sudo pacman -Scc --noconfirm
    sudo rm -rf /var/cache/pacman/pkg/* /tmp/*

# 🛠️ Install system tools (Priority 2 - Common CLI tools)
install-system-tools: install-system-core
    sudo pacman -S --noconfirm \
        neovim \
        htop \
        tree \
        unzip \
        jq \
        ripgrep \
        fd \
        bat \
        eza \
        dust \
        just \
        direnv \
        zoxide \
        fzf

# 🔧 Install AUR packages (if yay is available)
install-aur-packages:
    @if command -v yay >/dev/null 2>&1; then \
        echo "📦 Installing AUR packages..."; \
        yay -S --noconfirm \
            emacs-plus \
            visual-studio-code-bin; \
    else \
        echo "⚠️  AUR helper (yay) not available - install with bootstrap-typical or bootstrap-max"; \
    fi

# 🔧 Install additional development tools
install-additional-dev: install-system-tools
    sudo pacman -S --noconfirm \
        gcc \
        clang \
        cmake \
        ninja \
        gdb \
        lldb \
        rust \
        go

# 📧 Install email tools
install-email-tools: install-system-core
    sudo pacman -S --noconfirm \
        isync \
        mu \
        msmtp

# 🎨 Install GUI tools (if needed)
install-gui-tools: install-system-core
    sudo pacman -S --noconfirm \
        emacs \
        firefox \
        code

# 🔤 Install fonts
install-fonts: install-system-core
    sudo pacman -S --noconfirm \
        ttf-iosevka-nerd \
        ttf-fira-code \
        noto-fonts \
        noto-fonts-emoji


# =============================================================================
# LEVEL-BASED INSTALLATION (matches bootstrap levels)
# =============================================================================

# 🔰 Basic level - system packages only (requires bootstrap-basic)
install-basic: install-system-tools setup-dev-environment
    @echo "✅ Basic Arch install complete (pacman packages only)!"

# 🔶 Typical level - system + AUR packages (requires bootstrap-typical with yay)
install-typical: install-basic install-aur-packages install-gui-tools install-fonts install-email-tools
    @echo "✅ Typical Arch install complete (pacman + AUR packages)!"

# 🔸 Max level - all package managers + dev tools (requires bootstrap-max)
install-max: install-typical install-additional-dev
    @echo "✅ Max Arch install complete (pacman + AUR + all dev tools)!"

# 🔍 Verify installation
verify-installation:
    @echo "Verifying Arch installation..."
    @command -v git >/dev/null && echo "✅ git" || echo "❌ git"
    @command -v stow >/dev/null && echo "✅ stow" || echo "❌ stow"
    @command -v tmux >/dev/null && echo "✅ tmux" || echo "❌ tmux"
    @command -v nvim >/dev/null && echo "✅ neovim" || echo "❌ neovim"
    @command -v zsh >/dev/null && echo "✅ zsh" || echo "❌ zsh"
    @command -v yay >/dev/null && echo "✅ yay (AUR)" || echo "❌ yay (AUR)"
    @just verify-dev-tools

# 📥 Install from requirements file
install-from-requirements file:
    python -m pip install -r {{file}}

# 📤 Export current pip packages
export-requirements:
    python -m pip freeze > requirements.txt

# 🧪 Install packages for testing environment
install-test: install-system-tools setup-dev-environment
    @echo "✅ Arch test environment ready!"
    @echo "This target is optimized for container testing"