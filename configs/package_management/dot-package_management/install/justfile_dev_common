#!/usr/bin/env just
# -*- mode: just -*-

# Common development tools installation
# Shared across all platforms - import this into platform-specific justfiles

# ğŸ Install Python development packages (universal)
install-python-dev:
    @echo "Creating Python development tools virtual environment..."
    @python3 -m venv {{env_var('HOME')}}/.local/share/python-dev-tools-venv
    @echo "Creating Python dev tools requirements file..."
    @cat > {{env_var('HOME')}}/.local/share/python-dev-tools-venv/requirements.txt << 'EOF'
black
pyflakes
isort
pytest
nose
pipenv
pynvim
EOF
    @echo "Installing Python development packages..."
    @cd {{env_var('HOME')}}/.local/share/python-dev-tools-venv && \
        ./bin/pip install --upgrade pip && \
        ./bin/pip install -r requirements.txt
    @echo "âœ… Dev tools installed in ~/.local/share/python-dev-tools-venv"
    @echo "ğŸ’¡ Add ~/.local/share/python-dev-tools-venv/bin to your PATH or configure your IDE to use this venv"

# ğŸ“¦ Install Node.js development packages (universal)
install-node-dev:
    @echo "Creating Node.js development tools directory..."
    mkdir -p ~/.local/share/nodejs-dev-tools
    @echo "Installing Node.js development packages locally..."
    cd ~/.local/share/nodejs-dev-tools && npm init -y && npm install \
        neovim \
        typescript \
        typescript-language-server \
        stylelint \
        js-beautify \
        js-tidy \
        prettier
    @echo "âœ… Node.js dev tools installed in ~/.local/share/nodejs-dev-tools"
    @echo "ğŸ’¡ Add ~/.local/share/nodejs-dev-tools/node_modules/.bin to your PATH or configure your IDE"

# ğŸ’ Install Ruby development packages (universal)
# TODO: Fix Ruby ERB dependency issue in containerized environments
# FIXME: gem install solargraph fails with "cannot load such file -- erb"
install-ruby-dev:
    @echo "Installing Ruby development packages..."
    @echo "âš ï¸  Ruby dev tools installation temporarily disabled due to ERB dependency issue"
    @echo "    Run 'gem install solargraph' manually after fixing Ruby environment"
    # gem install solargraph

# ğŸ¦€ Install Rust development packages (universal)
install-rust-dev:
    @echo "Installing Rust development packages..."
    @echo "Creating Rust dev tools directory and requirements file..."
    mkdir -p ~/.local/share/rust-dev-tools
    cat > ~/.local/share/rust-dev-tools/cargo-tools.txt << 'EOF'
cargo-watch
cargo-edit
cargo-tree
cargo-outdated
EOF
    @echo "Adding rustfmt and clippy components..."
    rustup component add rustfmt clippy
    @echo "Installing essential cargo tools..."
    cargo install \
        cargo-watch \
        cargo-edit \
        cargo-tree \
        cargo-outdated
    @echo "âœ… Rust dev tools installed"
    @echo "ğŸ’¡ Ensure ~/.cargo/bin is in your PATH for rust tools"
    @echo "ğŸ’¡ rust-analyzer should be installed via system package manager"

# ğŸ“‚ Setup common development directories
setup-dev-dirs:
    @echo "Setting up development directories..."
    mkdir -p ~/dev/{my,work,learning,tools}
    mkdir -p ~/.local/{bin,share}
    mkdir -p ~/.config

# ğŸ” Verify development tools installation
verify-dev-tools:
    @echo "Verifying development tools..."
    @command -v python3 >/dev/null && echo "âœ… python3" || echo "âŒ python3"
    @command -v pip3 >/dev/null && echo "âœ… pip3" || echo "âŒ pip3"
    @command -v node >/dev/null && echo "âœ… node" || echo "âŒ node"
    @command -v npm >/dev/null && echo "âœ… npm" || echo "âŒ npm"
    @command -v ruby >/dev/null && echo "âœ… ruby" || echo "âŒ ruby"
    @command -v gem >/dev/null && echo "âœ… gem" || echo "âŒ gem"
    @echo "Verifying Python dev tools venv..."
    @test -f ~/.local/share/python-dev-tools-venv/bin/python && echo "âœ… python-dev-tools-venv" || echo "âŒ python-dev-tools-venv"
    @test -f ~/.local/share/python-dev-tools-venv/bin/black && echo "âœ… black (venv)" || echo "âŒ black (venv)"
    @test -f ~/.local/share/python-dev-tools-venv/bin/pynvim && echo "âœ… pynvim (venv)" || echo "âŒ pynvim (venv)"
    @echo "Verifying Node.js dev tools..."
    @test -f ~/.local/share/nodejs-dev-tools/node_modules/.bin/prettier && echo "âœ… prettier (local)" || echo "âŒ prettier (local)"
    @test -f ~/.local/share/nodejs-dev-tools/node_modules/.bin/typescript && echo "âœ… typescript (local)" || echo "âŒ typescript (local)"
    @echo "Verifying Rust dev tools..."
    @command -v cargo >/dev/null && echo "âœ… cargo" || echo "âŒ cargo"
    @test -f ~/.cargo/bin/rust-analyzer && echo "âœ… rust-analyzer" || echo "âŒ rust-analyzer"
    @test -f ~/.cargo/bin/cargo-watch && echo "âœ… cargo-watch" || echo "âŒ cargo-watch"

# ğŸ’¡ Show IDE configuration help
show-dev-config:
    @echo "ğŸ Python Dev Tools Configuration:"
    @echo "   Virtual Environment: ~/.local/share/python-dev-tools-venv"
    @echo "   Python Executable:  ~/.local/share/python-dev-tools-venv/bin/python"
    @echo ""
    @echo "ğŸ“¦ Node.js Dev Tools Configuration:"
    @echo "   Local Directory: ~/.local/share/nodejs-dev-tools"
    @echo "   Binaries Path:   ~/.local/share/nodejs-dev-tools/node_modules/.bin"
    @echo ""
    @echo "ğŸ¦€ Rust Dev Tools Configuration:"
    @echo "   Cargo Home: ~/.cargo"
    @echo "   Binaries Path: ~/.cargo/bin"
    @echo ""
    @echo "ğŸ”§ IDE Configuration:"
    @echo "   Neovim: Set 'g:python3_host_prog' to '~/.local/share/python-dev-tools-venv/bin/python'"
    @echo "   Emacs:  Configure python interpreter path in your config"
    @echo "   VS Code: Set 'python.defaultInterpreterPath' to the venv python"
    @echo ""
    @echo "ğŸš€ Available Python tools:"
    @test -d ~/.local/share/python-dev-tools-venv/bin && ls ~/.local/share/python-dev-tools-venv/bin/ | grep -E "(black|pyflakes|isort|pytest|pynvim)" || echo "   (venv not created yet - run 'just install-python-dev')"
    @echo "ğŸš€ Available Node.js tools:"
    @test -d ~/.local/share/nodejs-dev-tools/node_modules/.bin && ls ~/.local/share/nodejs-dev-tools/node_modules/.bin/ | grep -E "(prettier|typescript|stylelint)" || echo "   (local install not created yet - run 'just install-node-dev')"
    @echo "ğŸš€ Available Rust tools:"
    @test -d ~/.cargo/bin && ls ~/.cargo/bin/ | grep -E "(rust-analyzer|cargo-watch|clippy)" || echo "   (cargo tools not installed yet - run 'just install-rust-dev')"

# ğŸš€ Complete development environment setup
setup-dev-environment: setup-dev-dirs install-python-dev install-node-dev install-ruby-dev install-rust-dev
    @echo "âœ… Common development environment setup complete!"
    @echo ""
    @just show-dev-config

# TODO: SSH key management
# Need to handle work/personal key separation:
# - Different keys for different contexts
# - Key naming conventions (id_ed25519_work, id_ed25519_personal)
# - SSH config management
# - Integration with git config per repo/directory