#!/usr/bin/env just
# -*- mode: just -*-

# Package installation for Ubuntu Linux
# Run once during initial machine setup
# Uses multiple package managers: apt (system) + homebrew + nix

import 'justfile_dev_common'

default:
    @just --list

# ðŸ“¦ Update system packages (always run first)
update-system:
    sudo apt update && sudo apt upgrade -y

# ðŸ”§ Install essential system packages (Priority 1 - Core)
install-system-core: update-system
    sudo apt install -y \
        build-essential \
        curl \
        wget \
        git \
        stow \
        zsh \
        tmux \
        python3 \
        python3-pip \
        nodejs \
        npm \
        ruby \
        ruby-dev \
        gpg \
        ca-certificates

# ðŸ› ï¸ Install system tools (Priority 2 - Common CLI tools)
install-system-tools: install-system-core
    sudo apt install -y \
        neovim \
        htop \
        tree \
        unzip \
        jq \
        ripgrep \
        fd-find \
        bat

# ðŸº Install Homebrew for Linux (Priority 3 - Modern packages)
install-homebrew:
    @echo "Installing Homebrew for Linux..."
    @if ! command -v brew >/dev/null 2>&1; then \
        /bin/bash -c "$$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"; \
        echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.profile; \
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"; \
    else \
        echo "Homebrew already installed"; \
    fi

# ðŸº Install Homebrew packages (newer versions than apt)
install-homebrew-packages: install-homebrew
    brew install \
        eza \
        dust \
        just \
        direnv \
        zoxide

# â„ï¸ Install Nix package manager (Priority 4 - Cutting edge)
install-nix:
    @echo "Installing Nix package manager..."
    @if ! command -v nix >/dev/null 2>&1; then \
        sh <(curl -L https://nixos.org/nix/install) --daemon; \
        echo "Restart your shell and run: nix-env -iA nixpkgs.home-manager"; \
    else \
        echo "Nix already installed"; \
    fi

# ðŸ”§ Install work-specific tools
install-work-tools: install-system-tools
    sudo apt install -y \
        docker.io \
        docker-compose
    # Add user to docker group
    sudo usermod -aG docker $$USER
    @echo "Log out and back in for docker group to take effect"

# ðŸ“§ Install email tools
install-email-tools: install-system-core
    sudo apt install -y \
        isync \
        mu4e \
        msmtp

# ðŸŽ¨ Install GUI tools (if needed)
install-gui-tools: install-system-core
    sudo apt install -y \
        emacs \
        firefox \
        code

# ðŸš€ Essential setup (core + tools + development)
install-essential: install-system-tools install-homebrew-packages setup-dev-environment
    @echo "âœ… Essential Ubuntu setup complete!"

# ðŸ  Home setup (essential + GUI + email)
install-home: install-essential install-gui-tools install-email-tools
    @echo "âœ… Ubuntu home setup complete!"

# ðŸ’¼ Work setup (essential + work tools)
install-work: install-essential install-work-tools
    @echo "âœ… Ubuntu work setup complete!"

# ðŸ§ª Experimental setup (with Nix)
install-experimental: install-essential install-nix
    @echo "âœ… Ubuntu experimental setup complete!"
    @echo "Next: Configure Nix home-manager"

# ðŸ” Verify installation
verify-installation:
    @echo "Verifying Ubuntu installation..."
    @command -v git >/dev/null && echo "âœ… git" || echo "âŒ git"
    @command -v stow >/dev/null && echo "âœ… stow" || echo "âŒ stow"
    @command -v tmux >/dev/null && echo "âœ… tmux" || echo "âŒ tmux"
    @command -v nvim >/dev/null && echo "âœ… neovim" || echo "âŒ neovim"
    @command -v zsh >/dev/null && echo "âœ… zsh" || echo "âŒ zsh"
    @command -v brew >/dev/null && echo "âœ… homebrew" || echo "âŒ homebrew"
    @just verify-dev-tools

# ðŸ“¥ Install from requirements file
install-from-requirements file:
    python3 -m pip install -r {{file}}

# ðŸ“¤ Export current pip packages
export-requirements:
    python3 -m pip freeze > requirements.txt