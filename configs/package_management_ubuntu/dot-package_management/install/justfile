#!/usr/bin/env just
# -*- mode: just -*-

# Package installation for Ubuntu Linux
# Run once during initial machine setup
# Uses multiple package managers: apt (system) + homebrew + nix

import 'justfile_dev_common'

default:
    @just --list

# ðŸ“¦ Update system packages (always run first)
update-system:
    sudo apt update && sudo apt upgrade -y

# ðŸ”§ Install essential system packages (Priority 1 - Core)
install-system-core: update-system
    sudo apt install -y \
        build-essential \
        curl \
        wget \
        git \
        stow \
        zsh \
        tmux \
        python3 \
        python3-pip \
        python3-venv \
        nodejs \
        npm \
        ruby \
        ruby-dev \
        rustc \
        cargo \
        gpg \
        ca-certificates

# ðŸ› ï¸ Install system tools (Priority 2 - Common CLI tools)
install-system-tools: install-system-core
    sudo apt install -y \
        neovim \
        htop \
        tree \
        unzip \
        jq \
        ripgrep \
        fd-find \
        bat

# ðŸº Install Homebrew packages (if homebrew is available)
install-homebrew-packages:
    @if command -v brew >/dev/null 2>&1; then \
        echo "ðŸ“¦ Installing Homebrew packages..."; \
        brew install \
            eza \
            dust \
            just \
            direnv \
            zoxide; \
    else \
        echo "âš ï¸  Homebrew not available - install with bootstrap-typical or bootstrap-max"; \
    fi

# â„ï¸ Install Nix packages (if nix is available)
install-nix-packages:
    @if command -v nix >/dev/null 2>&1; then \
        echo "ðŸ“¦ Installing Nix packages..."; \
        nix-env -i \
            ripgrep \
            fd \
            bat; \
    else \
        echo "âš ï¸  Nix not available - install with bootstrap-max"; \
    fi

# ðŸ”§ Install work-specific tools
install-work-tools: install-system-tools
    sudo apt install -y \
        docker.io \
        docker-compose
    # Add user to docker group
    sudo usermod -aG docker $$USER
    @echo "Log out and back in for docker group to take effect"

# ðŸ“§ Install email tools
install-email-tools: install-system-core
    sudo apt install -y \
        isync \
        mu4e \
        msmtp

# ðŸŽ¨ Install GUI tools (if needed)
install-gui-tools: install-system-core
    sudo apt install -y \
        emacs \
        firefox \
        code

# =============================================================================
# LEVEL-BASED INSTALLATION (matches bootstrap levels)
# =============================================================================

# ðŸ”° Basic level - system packages only (requires bootstrap-basic)
install-basic: install-system-tools setup-dev-environment
    @echo "âœ… Basic Ubuntu install complete (apt packages only)!"

# ðŸ”¶ Typical level - system + homebrew packages (requires bootstrap-typical)
install-typical: install-basic install-homebrew-packages install-gui-tools install-email-tools
    @echo "âœ… Typical Ubuntu install complete (apt + homebrew packages)!"

# ðŸ”¸ Max level - all package managers (requires bootstrap-max)
install-max: install-typical install-nix-packages install-work-tools
    @echo "âœ… Max Ubuntu install complete (apt + homebrew + nix packages)!"

# ðŸ” Verify installation
verify-installation:
    @echo "Verifying Ubuntu installation..."
    @command -v git >/dev/null && echo "âœ… git" || echo "âŒ git"
    @command -v stow >/dev/null && echo "âœ… stow" || echo "âŒ stow"
    @command -v tmux >/dev/null && echo "âœ… tmux" || echo "âŒ tmux"
    @command -v nvim >/dev/null && echo "âœ… neovim" || echo "âŒ neovim"
    @command -v zsh >/dev/null && echo "âœ… zsh" || echo "âŒ zsh"
    @command -v brew >/dev/null && echo "âœ… homebrew" || echo "âŒ homebrew"
    @just verify-dev-tools

# ðŸ“¥ Install from requirements file
install-from-requirements file:
    python3 -m pip install -r {{file}}

# ðŸ“¤ Export current pip packages
export-requirements:
    python3 -m pip freeze > requirements.txt

# ðŸ§ª Install packages for testing environment
install-test: install-system-tools setup-dev-environment
    @echo "âœ… Ubuntu test environment ready!"
    @echo "This target is optimized for container testing"